{"version":3,"sources":["../../../../assets/Script/assets/Script/game-manager.js"],"names":["GameManager","cc","Class","properties","rowCount","columnCount","space","cubes","columnPositions","rowPositions","cubeTemplate","Node","cubePrefabs","gameNode_","halfWidth","halfHeight","maxLevel","maxHistory","leftTime","newLineTime","mainNode","state","default","Idle","type","setState","init","prefabs","auSource","instance","getStorage","getChildByName","width","height","instantiate","au_","reset","parseInt","showStarDes","onHide","Pause","log","bind","restart","getComponent","Animation","play","clear","Running","initCubes","foreachCubes","item","cell","removeFromParent","cb","i","length","row","j","column","randColorCube","max","Blue","color","Math","floor","random","tmp","push","cube","error","randLevel","x","y","createCube","posToPoint","pos","warn","removeCube","emit","EventType","TOUCH_END","cubeCom","cubeMoved","position","oldCell","setCellPos","getCube","setCube","levelChange","level","setStorage","toString","submitScore","dataManager","userInfo","userId3","game","savePlayerData","sys","platform","WECHAT_GAME","wx","key","data","success","console","update","dt","addNewLine","isDead","topLine","gameOver","AddNewLine","setTimeout","Over","parent","playBombSound","index","hideStarDes","window","gameManager"],"mappings":"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","file":"game-manager.js","sourceRoot":"../../../../assets/Script","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\nimport {CubeState,CubeColors,GameState} from \"consts\";\nimport Platform from \"./platform/platform\";\nvar GameManager=cc.Class({\n\n  properties: {\n    rowCount: 8,\n    columnCount: 7,\n    space: 5,\n\n    cubes: [],\n    columnPositions:[],\n    rowPositions:[],\n    cubeTemplate:cc.Node,\n    cubePrefabs:[],\n    gameNode_: null,\n\n    halfWidth:0,\n    halfHeight:0,\n\n    maxLevel:0,\n    maxHistory:0,\n    leftTime:10,\n    newLineTime:10,\n\n    mainNode:cc.Node,\n\n    state:{\n      default:GameState.Idle,\n      type:GameState,\n    }\n  },\n\n  setState(state){\n    if(this.state===state){\n      return;\n    }\n    this.state=state;\n  },\n\n  init(prefabs,mainNode,auSource) {\n    Platform.instance.getStorage(\"maxLevel\",function(maxLevel){\n      this.mainNode=mainNode;\n      this.gameNode_ = mainNode.getChildByName(\"game-node\");\n      this.cubePrefabs=prefabs;\n\n      this.halfWidth=this.gameNode_.width/2;\n      this.halfHeight=this.gameNode_.height/2;\n\n      this.cubeTemplate=cc.instantiate(this.cubePrefabs[0]);\n\n      this.au_=auSource;\n\n      this.reset();\n      this.maxLevel=0;\n      if (maxLevel){\n        this.maxHistory=parseInt(maxLevel);\n      }\n\n      if (this.maxLevel<=0){\n        this.showStarDes(this.maxLevel);\n      }\n\n      Platform.instance.onHide(()=>{\n        this.setState(GameState.Pause);\n      });\n\n      cc.log(\"game manager init\");\n    }.bind(this));\n\n  },\n\n  restart(){\n    this.reset();\n    this.mainNode.getComponent(cc.Animation).play(\"game-restart\");\n  },\n\n  reset(){\n    this.clear();\n\n    this.setState(GameState.Running);\n    this.leftTime=this.newLineTime;\n    this.maxLevel=0;\n    this.initCubes();\n  },\n\n  clear(){\n    this.foreachCubes((item,cell)=>{\n      if (item){\n        item.removeFromParent();\n      }\n    });\n    // this.gameNode_.removeAllChildren(true);\n  },\n\n  foreachCubes(cb){\n    for (let i=0;i<this.cubes.length;i++){\n      let row=this.cubes[i];\n      for (let j=0;j<row.length;j++){\n        cb(row[j],{row:i,column:j});\n      }\n    }\n  },\n\n  randColorCube(){\n    let max=CubeColors.Blue+1;\n    let color=Math.floor(Math.random()*10)%max;\n    return cc.instantiate(this.cubePrefabs[color]);\n  },\n\n  initCubes() {\n    this.cubes=[];\n    //初始化数组\n    for (let i=0;i<this.rowCount;i++){\n      let tmp=[];\n      for (let j=0;j<this.columnCount;j++){\n        tmp.push(null);\n        //cube的x坐标\n        if (this.columnPositions.length<this.columnCount){\n          this.columnPositions.push(this.space+this.cubeTemplate.width/2+(this.cubeTemplate.width+this.space)*j);\n        }\n        //cube的y坐标\n        if (this.rowPositions.length<this.rowCount){\n          this.rowPositions.push(this.space+this.cubeTemplate.height/2+(this.cubeTemplate.height+this.space)*j);\n        }\n      }\n      this.cubes.push(tmp);\n    }\n\n    //初始化cube\n    for (let i = 0; i < 2; i++) {\n      for (let j = 0; j < this.columnCount; j ++) {\n        let cube=this.randColorCube();\n        if (!cube){\n          cc.error(\"init cube fail\");\n          return;\n        }\n        cube.getComponent(\"cube\").init({row:i,column:j},this.randLevel());\n        cube.x=this.space+cube.width/2+(cube.width+this.space)*j;\n        cube.y=this.space+cube.height/2+(cube.height+this.space)*i;\n\n        // cube.parent=this.gameNode_;\n\n        this.cubes[i][j]=this.createCube({row:i,column:j});\n      }\n    }\n  },\n\n  randLevel(){\n    // if (this.maxLevel<3){\n    //   return  parseInt(Math.random()*10)%2;\n    // }\n    // if (this.maxLevel<6){\n    //   return parseInt(Math.random()*10)%(this.maxLevel);\n    // }\n    // if (this.maxLevel<11){\n    //   return parseInt(Math.random()*10)%(this.maxLevel-1);\n    // }\n    // return Math.min(5+parseInt(Math.random()*10)%(this.maxLevel-5),14);\n    if (this.maxLevel<=0){\n      return this.maxLevel;\n    }\n    return parseInt(Math.random()*10)%this.maxLevel;\n  },\n\n  posToPoint(pos){\n    let cell={row:0,column:0};\n    for (let i=0;i<this.rowCount;i++){\n      if (pos.y > (i+1) * (this.cubeTemplate.height+this.space)){\n        continue;\n      }\n      cell.row=i;\n      for (let j=0;j<this.columnCount;j++){\n        if (pos.x<(j+1) * (this.cubeTemplate.width+this.space)){\n          cell.column=j;\n          return cell;\n        }\n      }\n    }\n\n    cc.warn(\"invalid touch position\");\n    return cell;\n  },\n\n  removeCube(cube){\n    this.gameNode_.emit(cc.Node.EventType.TOUCH_END);\n    cube.removeFromParent();\n    let cubeCom=cube.getComponent(\"cube\");\n\n    this.cubes[cubeCom.cell.row][cubeCom.cell.column]=null;\n\n  },\n\n  //移动数组位置到显示位置\n  cubeMoved(cube){\n    cc.log(\"cube moved\");\n    let cell=this.posToPoint(cube.position);\n    if (this.cubes[cell.row][this.column]){\n      cc.error(\"can not move cube\");\n      return;\n    }\n    let cubeCom=cube.getComponent(\"cube\");\n    let oldCell=cubeCom.cell;\n    if (this.cubes[oldCell.row][oldCell.column]===cube){  //删除旧位置信息\n      this.cubes[oldCell.row][oldCell.column]=null;\n    }\n    // else if(this.cubes[oldCell.row][oldCell.column]&&this.cubes[oldCell.row][oldCell.column]!==cube){//当前位置已存在\n    //   if (cell.row>=this.cubes.length-2){\n    //     cc.warn(\"move to top\");\n    //     return;\n    //   }\n    //   cell.row+=1;\n    // }\n\n    this.cubes[cell.row][cell.column]=cube;\n    cubeCom.setCellPos(cell);\n  },\n\n  getCube(row,column){\n    return this.cubes[row][column];\n  },\n\n  setCube(row,column,cube){\n    if (this.cubes[row][column]){\n      cc.warn(\"can not set,cell is not nil\");\n      return;\n    }\n    this.cubes[row][column]=cube;\n  },\n\n  levelChange(level){\n    if (level>this.maxLevel){\n      this.maxLevel=level;\n      this.showStarDes(this.maxLevel);\n      if (this.maxLevel>this.maxHistory){\n        this.maxHistory=this.maxLevel;\n        Platform.instance.setStorage(\"maxLevel\",this.maxLevel.toString());\n        Platform.instance.submitScore(dataManager.userInfo.userId3,this.maxLevel);\n      }\n      cc.game.emit(\"max-level-changed\");\n    }\n  },\n\n  savePlayerData(){\n    if (cc.sys.platform === cc.sys.WECHAT_GAME){\n      wx.setStorage({\n        key:\"maxLevel\",\n        data:this.maxLevel.toString(),\n        success:()=>{\n          console.log(\"save level success\");\n        }\n      })\n    }\n  },\n\n  update (dt) {\n    // this.checkFallingDownPosition();\n    if(this.state!==GameState.Running){\n      return;\n    }\n    this.leftTime-=dt;\n    if (this.leftTime<=0){\n      this.addNewLine();\n      this.leftTime=this.newLineTime;\n    }\n  },\n\n  isDead(){\n    let topLine=this.cubes[this.cubes.length-1];\n    for (let i=0;i<topLine.length;i++){\n      if (topLine[i]){\n        return true;\n      }\n    }\n    return false;\n  },\n\n  addNewLine(){\n    if(this.isDead()){\n      this.gameOver();\n      return;\n    }\n    this.setState(GameState.AddNewLine);\n    cc.game.emit(\"add-new-line\");\n    for(let i=0;i<this.cubes.length;i++) {\n      let row=this.cubes[i];\n      for (let j=0;j<row.length;j++) {\n        let cube=row[j];\n        if (!cube){\n          continue;\n        }\n        // if (cube.getComponent(\"cube\").state!==CubeState.Normal){\n        //   continue;\n        // }\n        cube.emit(\"move-up\");\n        // this.cubes[i][j]=null;\n      }\n    }\n\n    //避免新旧碰撞，延迟加载新0星球\n    setTimeout(()=>{\n      if (this.state!=GameState.AddNewLine){\n        return;\n      }\n      this.setState(GameState.Running);\n      for (let i=0;i<this.columnCount;i++){\n        let cube=this.createCube({row:0,column:i});\n        // cube.y=-cube.height/2;\n        this.cubes[0][i]=cube;\n        // cube.emit(\"move-up\");\n      }\n    },150);\n  },\n  gameOver(){\n    this.setState(GameState.Over);\n    cc.game.emit(\"game-over\");\n    this.mainNode.getComponent(cc.Animation).play(\"game-over\");\n  },\n  createCube(cell){\n    let cube=cc.instantiate(this.cubePrefabs[0]);\n    cube.x=this.space+cube.width/2+(cube.width+this.space)*cell.column;\n    cube.y=this.space+cube.height/2+(cube.height+this.space)*cell.row;\n    cube.parent=this.gameNode_;\n    cube.getComponent(\"cube\").init(cell,this.randLevel());\n    return cube;\n  },\n  playBombSound(){\n    this.au_.play();\n  },\n\n  showStarDes(index){\n    // let node=cc.find(\"star-description\");\n    // if (!node){\n    //   cc.warn(\"star-description is not find\");\n    //   return;\n    // }\n    //\n    // node.getComponent(node.name).init(index);\n    // node.active=true;\n  },\n\n  hideStarDes(index){\n    // let node=cc.find(\"star-description\");\n    // if (!node){\n    //   cc.warn(\"star-description is not find\");\n    //   return;\n    // }\n    // // node.getComponent(node.name).init(index);\n    // node.active=false;\n  },\n});\n\nwindow.gameManager=new GameManager();\n"]}
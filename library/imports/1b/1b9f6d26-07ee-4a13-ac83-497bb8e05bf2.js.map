{"version":3,"sources":["../../../../../assets/Script/prefab/assets/Script/prefab/cube.js"],"names":["cc","Class","extends","Component","properties","level","state","default","Normal","type","cell","p","levelFrames","SpriteFrame","background","Sprite","levelUpAnimation","Prefab","onLoad","node","on","Node","EventType","TOUCH_START","onTouchStart","TOUCH_MOVE","onTouchMove","TOUCH_CANCEL","onTouchEnd","TOUCH_END","onLevelUp","onMoveUp","game","isTouched","row","moveTo","pAdd","position","height","gameManager","space","runAction","touchStartPos","Touched","TouchMove","levelChange","safeChangeLevelFrame","playLevelUpAnimation","playBombSound","log","toString","spriteFrame","Math","min","length","init","start","setCellPos","setState","js","formatStr","Bombing","error","disablePhysics","cubeMoved","FallingDown","activePhysics","FallingBottom","update","dt","removeCube","fitCell","checkFallingDown","resetY","y","touch","getLocation","parent","emit","resetX","dis","pDistance","pSub","newCell","posToPoint","column","checkBombing","cube1","cube2","onBeginContact","contact","selfCollider","otherCollider","body","RigidBodyType","Static","cubeSelf","getComponent","cubeOther","rowPositions","x","columnPositions","RigidBody","awake","Dynamic","downCube","getCube","Block","sequence","callFunc","ani","instantiate","addChild"],"mappings":"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","file":"cube.js","sourceRoot":"../../../../../assets/Script/prefab","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\n// import {CubeState} from './color-cube';\nimport {CubeState} from \"../consts\";\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    level: 0,\n    state:{\n      default:CubeState.Normal,\n      type:CubeState\n    },\n    cell:cc.p(0,0),\n    levelFrames:[cc.SpriteFrame],\n    background:cc.Sprite,\n    levelUpAnimation:cc.Prefab\n  },\n\n  // LIFE-CYCLE CALLBACKS:\n\n  onLoad() {\n    this.node.on(cc.Node.EventType.TOUCH_START,this.onTouchStart,this);\n    this.node.on(cc.Node.EventType.TOUCH_MOVE,this.onTouchMove,this);\n    // this.gameNode = cc.find(\"/Canvas/game-node\", cc.director.getRunningScene());\n    this.node.on(cc.Node.EventType.TOUCH_CANCEL,this.onTouchEnd,this);\n    this.node.on(cc.Node.EventType.TOUCH_END,this.onTouchEnd,this);\n\n    this.node.on(\"level-up\",this.onLevelUp,this);\n\n    this.node.on(\"move-up\",this.onMoveUp,this);\n\n    cc.game.on(\"add-new-line\",()=>{\n      if (!this.isTouched()||this.cell.row>0){\n        return;\n      }\n      let moveTo=cc.moveTo(0.2,cc.pAdd(this.node.position,cc.p(0,this.node.height+gameManager.space)));\n      this.node.runAction(moveTo);\n    });\n\n    this.touchStartPos=cc.p(0,0);\n  },\n\n  isTouched(){\n    return this.state===CubeState.Touched||this.state===CubeState.TouchMove;\n  },\n\n  // destroy(){\n  //   this.gameNode.off(cc.Node.EventType.TOUCH_END,this.onTouchEnd,this);\n  // },\n\n  onLevelUp(){\n    this.level++;\n    gameManager.levelChange(this.level);\n    this.safeChangeLevelFrame();\n    // gameManager.playDeadAction(this.node.position);\n    this.playLevelUpAnimation();\n    gameManager.playBombSound();\n  },\n\n  safeChangeLevelFrame(){\n    cc.log(\"safe change sprite frame,level:\",this.level.toString());\n    // if (this.level>=this.levelFrames.length){\n    //   this.level=this.levelFrames.length-1;\n    // }\n    this.background.spriteFrame=this.levelFrames[Math.min(this.level,this.levelFrames.length-1)];\n  },\n\n  init(cell,level) {\n    this.cell=cell;\n    this.level=level;\n    // this.\n    this.safeChangeLevelFrame();\n    // this.setState(CubeState.Block);\n  },\n\n  start() {\n\n  },\n\n  setCellPos(cell){\n    this.cell=cell;\n  },\n\n  setState(state) {\n    cc.log(cc.js.formatStr(\"set state,old:%d,new:%d,pos:%v\",this.state,state,this.cell));\n    if (this.state===CubeState.Bombing){\n      cc.error(\"cube is marking dead\");\n      return;\n    }\n    if (this.state===state){\n      return;\n    }\n    switch (state){\n      case CubeState.Normal:{\n        this.disablePhysics();\n        gameManager.cubeMoved(this.node);\n        break;\n      }\n      case CubeState.TouchMove:{\n        break;\n      }\n      case CubeState.Touched:\n      case CubeState.FallingDown:{\n        this.activePhysics();\n        // this.resetX();\n      }\n      case CubeState.FallingBottom:{\n        break;\n      }\n    }\n    this.state=state;\n  },\n\n  update(dt) {\n    switch (this.state){\n      case CubeState.Bombing:{\n        gameManager.removeCube(this.node);\n        break;\n      }\n      case CubeState.TouchMove:{\n        this.fitCell();\n        break;\n      }\n      case CubeState.Normal:{\n        // this.disablePhysics();\n        this.checkFallingDown();\n        break;\n      }\n      case CubeState.FallingBottom:{\n        this.resetY();\n        this.setState(CubeState.Normal);\n        break;\n      }\n    }\n    //非touch状态时进行触底检查\n    if (this.state!==CubeState.Touched&&this.state!==CubeState.TouchMove){\n      if (this.node.y<this.node.height/2+gameManager.space){\n        this.setState(CubeState.FallingBottom);\n      }\n    }\n  },\n\n  onTouchStart(touch){\n    cc.log(\"on touch start\");\n    this.setState(CubeState.Touched);\n    // let body=this.node.getComponent(cc.RigidBody);\n    // body.awake=true;\n    // body.type=cc.RigidBodyType.Dynamic;\n\n    this.activePhysics();\n    this.touchStartPos=touch.getLocation();\n  },\n\n  onTouchEnd(touch){\n    cc.log(\"on touch end\");\n    this.node.parent.emit(cc.Node.EventType.TOUCH_END);   //告知touch关节触摸结束\n    if (this.state!==CubeState.Touched&&this.state!==CubeState.TouchMove){\n      return;\n    }\n    //重置mouse关节的冲量\n    this.disablePhysics();\n    this.setState(CubeState.FallingDown);\n    this.resetX();\n\n    this.touchStartPos=cc.p(0,0);\n  },\n\n  onTouchMove(touch){\n    cc.log(\"on touch moved\");\n    let dis=cc.pDistance(cc.pSub(touch.getLocation(),this.touchStartPos),cc.p(0,0));\n    if (dis>3){\n      if (this.state===CubeState.Touched){\n        this.setState(CubeState.TouchMove);\n        // gameManager.cubeMove(this.cell);\n\n      }\n    }\n  },\n\n  fitCell(){\n    let newCell=gameManager.posToPoint(this.node.position);\n    if (newCell.row!==this.cell.row||newCell.column!==this.cell.column){\n      gameManager.cubeMoved(this.node);\n\n    }\n  },\n\n  checkBombing(cube1,cube2){\n    if (cube1.level !== cube2.level) {\n      return false;\n    }\n\n    if (cube1.state === CubeState.Bombing) {\n      return false;\n    }\n\n    if (cube1.state===CubeState.TouchMove||cube1.state===CubeState.FallingDown){\n      return true;\n    }\n    return false;\n  },\n\n  //仅动态类型才处理碰撞\n  onBeginContact: function (contact, selfCollider, otherCollider) {\n    if (selfCollider.body.type===cc.RigidBodyType.Static){\n      return;\n    }\n\n    let cubeSelf=selfCollider.node.getComponent(\"cube\");\n    let cubeOther=otherCollider.getComponent(\"cube\");\n    if (!cubeSelf||!cubeOther){\n      return;\n    }\n\n    if (this.checkBombing(cubeSelf,cubeOther)){\n      cubeSelf.setState(CubeState.Bombing);\n      cubeOther.node.emit(\"level-up\");\n    }\n\n    if (cubeSelf.state===CubeState.FallingDown){\n      cubeSelf.setState(CubeState.FallingBottom);\n    }\n  },\n\n  resetY(){\n    //更新cube的y坐标\n    cc.log(\"reset y called\");\n    let cell=gameManager.posToPoint(this.node.position);\n    this.node.y=gameManager.rowPositions[cell.row];\n  },\n  resetX(){\n    //更新cube的x坐标\n    cc.log(\"reset x called\");\n    let cell=gameManager.posToPoint(this.node.position);\n    this.node.x=gameManager.columnPositions[cell.column];\n    cc.log(\"reset x,new x:\"+this.node.x.toString());\n  },\n\n  activePhysics(){\n    let body=this.node.getComponent(cc.RigidBody);\n    body.awake=true;\n    body.type=cc.RigidBodyType.Dynamic;\n  },\n\n  disablePhysics(){\n    let body=this.node.getComponent(cc.RigidBody);\n    if (body.type!==cc.RigidBodyType.Static){\n      body.type=cc.RigidBodyType.Static;\n    }\n  },\n\n  checkFallingDown(){\n    if (this.cell.row<=0){\n      return;\n    }\n    let downCube=gameManager.getCube(this.cell.row-1,this.cell.column);\n    if (!downCube){\n      this.setState(CubeState.FallingDown);\n    }\n  },\n\n  onMoveUp(){\n    if (this.state===CubeState.Touched||this.state===CubeState.TouchMove){\n      return;\n    }\n    this.setState(CubeState.Block);\n    let moveTo=cc.moveTo(0.2,cc.pAdd(this.node.position,cc.p(0,this.node.height+gameManager.space)));\n    this.node.runAction(cc.sequence(moveTo,cc.callFunc(()=>{\n      gameManager.cubeMoved(this.node);\n      this.setState(CubeState.Normal);\n    })));\n  },\n\n  playLevelUpAnimation(){\n    if (!this.levelUpAnimation){\n      return;\n    }\n    let ani=cc.instantiate(this.levelUpAnimation);\n    this.node.addChild(ani);\n  },\n});\n"]}
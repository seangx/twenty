'use strict';let consts={Version:'0.1.7',NetUrl:{Test:'https://platform-test.hortorgames.com',Prod:'https://platform.hortorgames.com'},Box:{appId:'wx3301a6cbd35d9935',path:'/pages/index/index'},Requests:{FetchAds:'/cross/api/v1/fetch',Log:'/cross/api/v1/log'},Errors:{NetWorkErr:{errCode:1e3,errMsg:'\u7F51\u7EDC\u9519\u8BEF'},AdsDataErr:{errCode:1001,errMsg:'\u6CA1\u6709\u5E7F\u544A\u6570\u636E'}},LogType:{ClickAd:1,ShowAd:2}};class Util{static assign(c,a){if(Object.assign)return Object.assign(c,a);for(let b in a)c[b]=a[b];return c}static jsonToQuery(a,b){if(!a)return'';let c=[];for(let d in a){let e=b?encodeURIComponent(a[d]):a[d];c.push(`${d}=${e}`)}return c.join('&')}static queryToJson(a){let b={};if(!a)return b;let c=decodeURIComponent(a),d=c.split('&');for(let c in d){let a=d[c].split('=');b[a[0]]=a[1]}return b}static getSystemInfo(){return this.systemInfo?this.systemInfo:(this.systemInfo=wx.getSystemInfoSync(),this.systemInfo.crossSDKV=consts.Version,this.systemInfo)}static getSystemInfoStr(){if(this.systemInfoStr)return this.systemInfoStr;let a=this.sliceJson(this.getSystemInfo(),['SDKVersion','brand','model','system','version','crossSDKV']);return this.systemInfoStr=JSON.stringify(a),this.systemInfoStr}static sliceJson(a,b){if(!a||!b)return{};'string'==typeof b&&(b=b.replace(/\s+/g,'').split(','));let c={};return b.map((b)=>{c[b]=a[b]}),c}static isFun(a){return a&&'function'==typeof a}static promisify(a){return function(b={}){return new Promise((c,d)=>{b.success=function(a){c(a)},b.fail=function(a){d(a)},a(b)})}}static setStorage(a,b,c){let d=c?`_${c}`:'',e=`_CSDK_${a}${d}`;e&&'undefined'!=typeof b&&wx.setStorageSync(e,b)}static getStorage(a,b){let c=b?`_${b}`:'',d=`_CSDK_${a}${c}`;return d?wx.getStorageSync(d):''}static clearStorage(a){wx.removeStorageSync(consts.StorageKeys[a])}}class NetWork{constructor(a){this.HOST=consts.NetUrl[a.env]}request(a,b,c,d){if(!a||!b)return!1;let{success:e,fail:f,complete:g,params:h}=c||{};h.sysInfo=Util.getSystemInfoStr();let i={"content-type":d?'application/json':'application/x-www-form-urlencoded'},j=(a)=>{let b={errMsg:a.errMsg||a||'',errCode:a.errCode||consts.Errors.NetWorkErr.errCode};Util.isFun(f)&&f(b)};return wx.request({url:b,data:h,method:a,header:i,success:(a)=>{let b=a.data;return 200==a.statusCode?b.meta&&0!=b.meta.errCode?j(b.meta):void(Util.isFun(e)&&e(b.data)):j(b)},complete:(a)=>{Util.isFun(g)&&g(a)},fail:j})}get(a,b){return this.request('GET',a,b)}post(a,b){return this.request('POST',a,b)}getJSON(a,b){return this.request('GET',a,b,!0)}postJSON(a,b){return this.request('POST',a,b,!0)}}class AppBridge{constructor(a){this.conf=a,this.network=new NetWork(a),this.keys=['type','bone_info','gif_info','icon'],this.defData={},this.change='',this.ads='',this.nowAd='',this.lastIndex='',this.isMiniGame='undefined'!=typeof GameGlobal&&'undefined'==typeof App,console.log('[CSDK] isMiniGame',this.isMiniGame),this.canUseNavigator=wx.canIUse&&wx.canIUse('navigateToMiniProgram')}postLog(a=consts.LogType.ShowAd,b){let c=Util.assign({prId:b.prId||'',logType:a},this.conf);this.network.post(this.network.HOST+consts.Requests.Log,{params:c})}_goApp(a){if(!a)return!1;if(!this.canUseNavigator)return!1;let{appId:b,path:c,envVersion:e='release',gameId:f='',prId:d,extraData:g={}}=a;(!b||f)&&(b=consts.Box.appId,c=`${consts.Box.path}?f=${this.conf.gameId}&t=${f}&prId=${d}`);let h={appId:b,path:c,envVersion:e,extraData:g,success:()=>{console.log('[CSDK] go app success')},fail:(a)=>{console.log('[CSDK] go app fail',a)}};console.log('[CSDK] goApp',h),wx.navigateToMiniProgram(h)}_goGame(a){this.isMiniGame?(console.log('[CSDK] preview ad ',a),wx.previewImage({urls:[a.url]})):this._goApp(a)}_getPathChannel(a){let b=a.path?a.path.split('?'):[],c=Util.queryToJson(b[1]);c.channel=`${this.conf.gameId}_box`;let d=Util.jsonToQuery(c);return`${b[0]||''}?${d}`}_setAds(a){let b=0;a.map((a)=>{b+=a.weight-0,a.path=this._getPathChannel(a)}),this.ads={ads:a,weight:b},this._reset()}_getAds(){return this.ads||{}}_setData(a){this.defData=Util.sliceJson(a,this.keys),this._setAds(a.ads)}_getData(a=this.nowAd){return a.icon?Util.sliceJson(a,this.keys):this.defData}_setLastIndex(a){this.lastIndex=a,Util.setStorage('LastIndex',a,this.adsId)}_getStorageIndex(){let a=parseInt(Util.getStorage('LastIndex',this.adsId),10);return isNaN(a)?'':(this.lastIndex=a,a)}_getLastIndex(){return''===this.lastIndex?this._getStorageIndex():this.lastIndex}_getRadomIndex(a){let{ads:b,weight:c}=a,d=Math.floor(Math.random()*c),e=0;return b.findIndex((a)=>{let b=a.weight,c=!!(e<=d&&d<e+b);return c||(e+=b),c})}_getRadomAdIndex(a){let b=this._getLastIndex(),c=this._getRadomIndex(a);return console.log('[SDK] _getRadomAdIndex',c),c==b?this._getRadomAdIndex(a):c}_getRadomAd(a){let{ads:b}=a,c=b.length,d=this._getLastIndex(),e='';return e=1===c?0:2===c?1===d?0:1:this._getRadomAdIndex(a),console.log('[SDK] _getRadomAd ',e,d),''===e?'':(this._setLastIndex(e),b[e])}_reset(){let a=this._getAds(),b=a.ads&&a.ads.length?this._getRadomAd(a):'';return!!b&&void(this.nowAd=b,this.postLog(consts.LogType.ShowAd,b),this.change&&this.change(this._getData(b)))}onChange(a){Util.isFun(a)&&(this.change=a)}show(){if(!this.nowAd)return console.log('[CSDK] no ad');let a=this.nowAd;this.postLog(consts.LogType.ClickAd,a),this._goGame(a),this._reset()}create(a){console.log('[CSDK] create',a.adsId);let{adsId:b}=a,{gameId:c,openId:d}=this.conf,e=(b)=>{Util.isFun(a.fail)&&a.fail(b),console.log('[CSDK] create fail',b)};this.adsId=b,this.network.post(this.network.HOST+consts.Requests.FetchAds,{params:{gameId:c,openId:d,adsId:b},success:(b)=>{if(!b.ads||!b.ads.length)return e(consts.Errors.AdsDataErr);this._setData(b);let c=this._getData();console.log('[CSDK] create success',c),Util.isFun(a.success)&&a.success(c)},fail:e})}static getInstance(a){return this.instance=this.instance||new AppBridge(a),this.instance}}let CrossSDK={ads:{},createAd(a){if(!a||!a.adsId)return console.warn('[CSDK] no adsId');let b=new AppBridge(this.conf);return b.create(a),this.ads[a.adsId]=b,b},showAd(a){let b='object'==typeof a?a.adsId:a;if(!b)return console.warn('[CSDK] no adsId');let c=this.ads[b];return c?void c.show():console.warn('[CSDK] no ad')},init(a){this.conf=a}};'undefined'==typeof App?'undefined'==typeof module?'undefined'!=typeof window&&(window.crossSDK=CrossSDK):module.exports=CrossSDK:function(a){function b(){this.crossSDK=new d(this)}let c=function(a,b,c){if(a[b]){let d=a[b];a[b]=function(a){c.call(this,a,b),d.call(this,a)}}else a[b]=function(a){c.call(this,a,b)}},d=function(a){this.app=a};d.prototype=a;let e=App;App=(a)=>{c(a,'onLaunch',b),e(a)}}(CrossSDK);
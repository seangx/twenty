'use strict';let consts={};consts.Version='1.3.2',consts.ClientVer='v1.0.0',consts.RunModeType={Dev:'Dev',Test:'Test',Prod:'Prod'},consts.RunMode=consts.RunModeType.Dev,consts.NetURL={Test:{HOST:'https://wxmini-test.hortorgames.com',logHOST:'https://wxmini-test.hortorgames.com',serveHOST:'https://platform-test.hortorgames.com'},Prod:{HOST:'https://wxmini.hortorgames.com',logHOST:'https://wxmini-log.hortorgames.com',serveHOST:'https://platform.hortorgames.com'}},consts.MessageHead={Login:'/mini/api/v1/code',WeakLogin:'/mini/api/v1/code/weak',GetUserInfo:'/mini/api/v1/test/userinfo',SetUserInfo:'/mini/api/v1/userinfo',CreateOrder:'/mini/api/v1/order',CancelOrder:'/mini/api/v1/order/cancel',MinigameCallback:'/mini/api/v1/pay/callback',ShareInfo:'/mini/api/v1/shareinfo',MpBinding:'/mini/api/v1/sdk/binding',Log:'/mini/api/v1/log',DefaultSet:'/mini/api/v1/defrule/get',IpCheck:'/ipregion/api/v1/blockstatus',ErrorLog:'/wxlog/api/v1/log'},consts.Errors={NetWorkErr:{errCode:1e3,errMsg:'\u7F51\u7EDC\u9519\u8BEF'},WXCodeErr:{errCode:1001,errMsg:'\u5FAE\u4FE1Code\u83B7\u53D6\u5931\u8D25'},PayCancel:{errCode:1002,errMsg:'\u652F\u4ED8\u53D6\u6D88'},PayFail:{errCode:1003,errMsg:'\u652F\u4ED8\u5931\u8D25'},WXSessionFail:{errCode:1004,errMsg:'\u5FAE\u4FE1session\u83B7\u53D6\u5931\u8D25'},WXGetShareInfoFail:{errCode:1005,errMsg:'\u83B7\u53D6\u5206\u4EAB\u6570\u636E\u5931\u8D25'}},consts.StorageKeys={UserInfo:'__miniSDK_User_Info',RunMode:'__miniSDK_Run_Mode',SaveTime:'__miniSDK_Save_Time',FailOrders:'__miniSDK_Fail_Orders',LastLogReportTime:'__miniSDK_Last_Log_Report_Time',LastLogReportStr:'__miniSDK_Last_Log_Report_Str',HeartBeatTime:'__miniSDK_Heart_Beat_Time'},consts.LogType={Scene:1,Share:2,Login:3,Channel:4,Signup:5,Flag:6,Err:7,MidashiPaySuccess:8,OrderPaySuccess:9,AuthFailed:10,ShareShowCount:11,ShareSuccessCount:12,MidashiPayCall:13,GameZone:14,ADClick:15,ADShow:16,ADClose:17};class Util{static isStartWith(a,b){let c=b.length;return 0<=c&&0===a.indexOf(b)}static showLoading(a){!this.loading&&wx.showLoading&&(this.loading=!0,wx.showLoading({title:a,mask:!0}))}static hideLoading(){this.loading=!1,wx.showLoading&&wx.hideLoading()}static assign(c,a){if(Object.assign)return Object.assign(c,a);for(let b in a)c[b]=a[b];return c}static jsonToQuery(a){let b=[];for(let c in a)b.push(`${c}=${a[c]}`);return b.join('&')}static queryToJson(a){let b={},c=decodeURIComponent(a),d=c.split('&');for(let c in d){let a=d[c].split('=');b[a[0]]=a[1]}return b}static resetBaseDef(a,b){for(let c in a=a||{},b=b||{},b)a[c]='undefined'==typeof a[c]?b[c]:a[c];return a}static getWXErrInfo(a){let b=a.errMsg.split(' ');return 2==b.length?b[1]:2<b.length?msg.slice(1).join(' '):'fail'}static utf8_decode(a){var b=String.fromCharCode,d='';for(let e=0,f=0,c=0,g=0;e<a.length;)f=a.charCodeAt(e),128>f?(d+=b(f),e++):191<f&&224>f?(c=a.charCodeAt(e+1),d+=b((31&f)<<6|63&c),e+=2):(c=a.charCodeAt(e+1),g=a.charCodeAt(e+2),d+=b((15&f)<<12|(63&c)<<6|63&g),e+=3);return d}static base64Decode(a){var b,c,d,e,f,g,h,j=String.fromCharCode,k='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=',l='',m=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,'');m<a.length;)e=k.indexOf(a.charAt(m++)),f=k.indexOf(a.charAt(m++)),g=k.indexOf(a.charAt(m++)),h=k.indexOf(a.charAt(m++)),b=e<<2|f>>4,c=(15&f)<<4|g>>2,d=(3&g)<<6|h,l+=j(b),64!=g&&(l+=j(c)),64!=h&&(l+=j(d));return Util.utf8_decode(l)}static getSystemInfo(){return this.systemInfo?this.systemInfo:(this.systemInfo=wx.getSystemInfoSync(),this.systemInfo.hortorSDKVersion=consts.Version,this.systemInfo)}static getSystemInfoStr(){if(this.systemInfoStr)return this.systemInfoStr;let a=this.getSystemInfo(),b={};return['SDKVersion','brand','model','system','version','hortorSDKVersion'].map((c)=>{b[c]=a[c]}),this.systemInfoStr=JSON.stringify(b),this.systemInfoStr}static compareVersion(a,b){a=a.split('.'),b=b.split('.');for(var c=Math.max(a.length,b.length);a.length<c;)a.push('0');for(;b.length<c;)b.push('0');for(var d=0;d<c;d++){var e=parseInt(a[d]),f=parseInt(b[d]);if(e>f)return 1;if(e<f)return-1}return 0}static geVersion(a){return 0<=this.compareVersion(this.getSystemInfo().SDKVersion,a)}static ltVersion(a){return 0>this.compareVersion(this.getSystemInfo().SDKVersion,a)}static isFun(a){return a&&'function'==typeof a}static getNowSec(){return Math.floor(new Date().getTime()/1e3)}}class NetWork{constructor(){}init(a){this.HOST=consts.NetURL[a.env].HOST,this.Log_HOST=consts.NetURL[a.env].logHOST,this.Serve_HOST=consts.NetURL[a.env].serveHOST,a.Server_URL&&(this.HOST=a.Server_URL)}request(a,b,c,d){let e=/^(https?:\/\/)/,f=e.test(b)?b:this.HOST+b,g=Util.assign({},c.params);g.sysInfo=Util.getSystemInfoStr();let h={"content-type":d?'application/json':'application/x-www-form-urlencoded'},i=(a)=>{let b={errMsg:a.errMsg||a||'',errCode:a.errCode||consts.Errors.NetWorkErr.errCode};Util.isFun(c.fail)?c.fail(b):console.warn('[SDK] request fail: ',b)};return wx.request({url:f,data:g,method:a,header:h,success:(a)=>{let b=a.data;return 200==a.statusCode?0==b.meta.errCode?void(Util.isFun(c.success)&&c.success(b.data)):i(b.meta):i(b)},complete:()=>{Util.isFun(c.complete)&&c.complete()},fail:i})}get(a,b){return this.request('GET',a,b)}post(a,b){return this.request('POST',a,b)}getJSON(a,b){return this.request('GET',a,b,!0)}postJSON(a,b){return this.request('POST',a,b,!0)}}class PayManagerGame{init(a){this.reportTimer=null,this.conf=this.conf||a,this.network=new NetWork,this.network.init(a),this.reportErrLog=this.reportErrLog.bind(this)}pay(a,b){this._createOrder(a,b)}reportErrLog(a=consts.LogType.Err,b,c){let d={logType:a,orderId:c,gameId:this.conf.gameId,errMsg:encodeURIComponent(JSON.stringify(b))};this.network.postJSON(`${this.network.Log_HOST}${consts.MessageHead.Log}`,{params:d})}_createOrder(a,b){if(!a)return console.warn('[SDK] _createOrder data null');let c=this,e=a.midashiPayInfo,f=a.orderId;var g=Object.assign({},e);this.reportErrLog(consts.LogType.MidashiPayCall,{msg:`[SDK] call midashi: ${f}`},f),g.success=()=>{this.reportErrLog(consts.LogType.MidashiPaySuccess,{msg:`[SDK] midashi success: ${f}`},f),this.network.post(consts.MessageHead.MinigameCallback,{params:{orderId:f},success:(a)=>{let d=null;'success'==a?this.reportErrLog(consts.LogType.OrderPaySuccess,{msg:`[SDK] MinigameCallback Success: ${f}`},f):d=consts.Errors.PayFail,d&&c.reportErrLog(consts.LogType.Err,d,f),b(d)},fail:(a)=>{a&&c.reportErrLog(consts.LogType.Err,a,f),b(consts.Errors.PayFail)}})},g.fail=(a)=>{c.network.post(consts.MessageHead.CancelOrder,{params:{orderId:f},success:(a)=>{console.log(`[SDK] cancel order: ${a}`)},fail:()=>{}}),b(a)},g.complete=()=>{},console.warn('[SDK] requestMidasPayment:',g);let h=Util.getSystemInfo();'ios'!=h.platform&&wx.requestMidasPayment(g)}}class SDKCore{constructor(){}addEvent(a,b){let c=this.events[a];c?this.events[a].push(b):(this.events[a]=[],this.events[a].push(b)),this.dispatchEvent('_sdkMethodAdded',a)}removeEvent(a){delete this.events[a]}dispatchEvent(a,b){let c=this.events[a];if(c)for(let a,d=0;d<c.length;d++)a=c[d],a(b)}_callHandle(a,b){if(a)for(let c,d=0;d<a.length;d++)c=a[d],c(b)}_handleOnShow(a){if(a){this.lastLaunchOptions=a;for(let b=0;b<this.sdkEvents.length;b++){let c=this.sdkEvents[b],d=this.events[c],e=a;'getMiniCode'==c&&(e=this.getSceneQuery(e)),this._callHandle(d,e)}}}_sdkMethodHandle(a){if(0<=this.sdkEvents.indexOf(a))for(let a=0;a<this.sdkEvents.length;a++){let b=this.sdkEvents[a],c=this.events[b],d=this.lastLaunchOptions;if('getMiniCode'==b){let a=this.getSceneQuery(d);a&&this._callHandle(c,a);continue}this._callHandle(c,d)}}getMiniCodeSync(){return this.getSceneQuery(this.lastLaunchOptions)}getSceneQuery(a){if(!a)return null;if(!a.query)return null;if(a.query.scene){let b=Util.queryToJson(a.query.scene);return b.channel?null:(b=Util.base64Decode(a.query.scene),b)}return null}init(a){this.conf=a,this.sdkEvents=['getMiniCode'],this.events={},this.lastLaunchOptions=null,this.addEvent('_handleOnShow',this._handleOnShow.bind(this)),this.addEvent('_sdkMethodAdded',this._sdkMethodHandle.bind(this))}static getInstance(a){return this.instance||(this.instance=new SDKCore,this.instance.init(a)),this.instance}}class LogManager{getUserInfo(){let a=wx.getStorageSync(consts.StorageKeys.UserInfo),b=a?a.userSdk:'';return this.user=a,b?{userId:b.userId,uniqueId:b.uniqueId}:''}doHandleOnShow(a,b){if(this.lastLaunchOptions=a,!this.launchFlag)return;let c={};if(c.gameId=this.conf.gameId,c.logType=1,c.content=a,c.scene=parseInt(c.content.scene),console.log('[SDK] On Show:',a),this.channel='hortor',c.content.query.channel&&''!=c.content.query.channel&&(this.channel=c.content.query.channel),c.content.query.scene){this.pageQuery=c.content.query.scene;let a=Util.queryToJson(c.content.query.scene);a.channel&&(this.channel=a.channel)}1074==c.scene&&(this.sceneQuery=c.content.query),c.content.query.shareConfigId&&(this.shareConfigId=c.content.query.shareConfigId),c.content.query.h_shareCode&&(this.h_shareCode=c.content.query.h_shareCode),c.channel=this.channel,c.shareConfigId=this.shareConfigId,this.scene=c.scene,SDKCore.getInstance().dispatchEvent('_handleOnShow',a);let d=this.getUserInfo();d&&(c=Util.assign(c,d),b&&this.postLog(c))}handleOnShow(a){this.doHandleOnShow(a,!1)}handleOnHide(a){SDKCore.getInstance().dispatchEvent('_handleOnHide',a)}getNow(){return Math.floor(new Date().getTime()/1e3)}getStorageReportStr(){return wx.getStorageSync(consts.StorageKeys.LastLogReportStr)||''}getStorageReportTime(){return wx.getStorageSync(consts.StorageKeys.LastLogReportTime)||this.getNow()}init(a){this.channel='hortor',this.shareConfigId='',this.h_shareCode='',this.scene=0,this.pageQuery='',this.sceneQuery={},this.lastReportStr=this.getStorageReportStr(),this.lastReportTime=this.getStorageReportTime(),this.conf=a,this.network=new NetWork,this.network.init(a),this.launchFlag=!0;let b=wx.getLaunchOptionsSync();this.handleOnShow(b,!1),this.launchFlag=!1,this.payManager=null,setTimeout(()=>{this.launchFlag=!0},1e3),wx.onShow(this.handleOnShow.bind(this)),wx.onHide(this.handleOnHide.bind(this))}repostSceneLog(){this.doHandleOnShow(this.lastLaunchOptions,!0)}postLog(a,b){if(!a.userId&&!a.uniqueId){let b=this.getUserInfo();b&&(a=Util.assign(a,b))}let c={params:a};b&&(c=Util.assign(c,b)),this.network.postJSON(`${this.network.Log_HOST}${consts.MessageHead.Log}`,c)}static getInstance(a){return this.instance||(this.instance=new LogManager,this.instance.init(a)),this.instance}}let EncodeEmpty={isEmpty:!0};class LoginManager{init(a){this.network=new NetWork,this.network.init(a),this.conf=a,this.log=LogManager.getInstance(a),this.useBtnGetUserInfo=this.conf.sdkSet.openBtnGetUserInfo&&Util.geVersion('2.0.1')&&wx.createUserInfoButton}getStorage(){let a=wx.getStorageSync(consts.StorageKeys.UserInfo);if(a){this._isAuthorizeLogin&&!a.userSdk.hasUserInfo&&(a=null);let b=wx.getStorageSync(consts.StorageKeys.SaveTime);if(b){let c=86400;this.conf.Expire_Time&&(c=parseInt(this.conf.Expire_Time));let d=Util.getNowSec();b+c<d&&(wx.removeStorageSync(consts.StorageKeys.SaveTime),a=null)}else a=null;console.log('[SDK] getStorage',a)}return a}checkSession(a){let b=this;wx.checkSession({success:()=>{console.log('[SDK] checkSession 1'),a(b.getStorage(),null)},fail:()=>{console.log('[SDK] checkSession 0'),b._clearStorage(),a(null,consts.Errors.WXSessionFail)}})}_clearStorage(){console.log('[SDK] _clearStorage'),wx.removeStorageSync(consts.StorageKeys.UserInfo)}wxLogin(a){wx.login({success:(b)=>{b.code?(console.log('[SDK] wx.login 1'),this.code=b.code,a(b.code,null)):(console.warn('[SDK] \u83B7\u53D6\u7528\u6237\u767B\u5F55\u51ED\u8BC1\u5931\u8D25 -'+b.errMsg),a(null,consts.Errors.WXCodeErr))},fail:(b)=>{console.warn('[SDK] \u83B7\u53D6\u7528\u6237\u767B\u5F55\u6001\u5931\u8D25! -'+b.errMsg),a(null,consts.Errors.WXCodeErr)}})}storageInfo(a){if(!a.encryptUserInfo)return!1;let b=wx.getStorageSync(consts.StorageKeys.UserInfo),c=Util.getNowSec();this._useEncode&&(!this.codeTemp&&console.warn('[SDK] use encode lost code'),a.encryptUserInfo.code=this.codeTemp),wx.setStorageSync(consts.StorageKeys.UserInfo,a),wx.setStorageSync(consts.StorageKeys.RunMode,this.conf.env),wx.setStorageSync(consts.StorageKeys.SaveTime,c),b||(console.log('[SDK] repostSceneLog'),this.log.repostSceneLog())}entry(a,b){let c={version:consts.Version,gameId:this.conf.gameId,channel:this.log.channel,query:this.log.pageQuery,shareConfigId:this.log.shareConfigId,h_shareCode:this.log.h_shareCode,isWeak:!this._isAuthorizeLogin};this._useEncode?(this.codeTemp=a,this.encodeManager=EncodeEmpty.getInstance(this.conf),c.nonce=this.encodeManager.encodeCode(a)):c.code=a,this.network.post(consts.MessageHead.Login,{params:c,success:(a)=>{console.log('[SDK] entry login: ',a),this.storageInfo(a),b(a,null)},fail:(a)=>{this._clearStorage(),b(null,a)}})}postUserInfo(a,b){return console.log('[SDK] postUserInfo'),Util.hideLoading(),b=b||this.userSdk,a&&b?void this.network.post(consts.MessageHead.SetUserInfo,{params:{entryAlias:'minisdk',gameId:this.conf.gameId,userId:b.userId,uniqueId:b.uniqueId,encryptedData:a.encryptedData,iv:a.iv},success:(a)=>{this.storageInfo(a),this.next(a.encryptUserInfo,null,this.checkSessionPass)},fail:(a)=>{this.next(null,a,this.checkSessionPass)}}):console.warn('[SDK] without userSdk')}decodeUserInfo(a,b){a.gameId=this.conf.gameId,this.network.post(consts.MessageHead.GetUserInfo,{params:a,success:(a)=>{let c=wx.getStorageSync(consts.StorageKeys.UserInfo)||{};c.encryptUserInfo&&(c.encryptUserInfo.userInfo=a),wx.setStorageSync(consts.StorageKeys.UserInfo,c),b(c.encryptUserInfo,null,this.checkSessionPass)},fail:(a)=>{b(null,a,this.checkSessionPass)}})}getGetUserInfoBtn(a,b){return this.setLoginBtn(a),this.onLoginBtn(b),this.getLoginBtn()}fetchUserInfoBtn(a){console.log('[SDK] fetchUserInfoBtn'),this.userSdk=a,this._checkAuth(this.fetchUserInfo.bind(this,a),this.showGetUserInfoBtn.bind(this))}fetchUserInfo(a){console.log('[SDK] fetchUserInfo'),wx.getUserInfo({lang:'zh_CN',success:(b)=>{this.postUserInfo(b,a)},fail:(a)=>{this.useBtnGetUserInfo&&Util.isFun(this.showGetUserInfoBtn)?this.showGetUserInfoBtn():this.next(null,consts.Errors.NetWorkErr,this.checkSessionPass),console.warn('[SDK] \u83B7\u53D6\u7528\u6237\u4FE1\u606F\u5931\u8D25-',a.errMsg)}})}_checkAuth(a,b){wx.getSetting({success:(c)=>{let d=c.authSetting['scope.userInfo'];d?a():Util.isFun(b)&&b()},fail:()=>{Util.isFun(b)&&b()}})}_showSetModal(a){wx.showModal({title:'\u63D0\u793A',content:'\u9700\u8981\u8BBE\u7F6E\u5F00\u542F\u5FAE\u4FE1\u8BBF\u95EE\u4FE1\u606F\u6743\u9650',showCancel:!0,cancelText:'\u77E5\u9053\u4E86',confirmText:'\u53BB\u8BBE\u7F6E',success:(b)=>{b.confirm&&this._toSetting(a)}})}_toSetting(a){wx.openSetting({success:(b)=>{b.authSetting['scope.userInfo']?Util.isFun(a)&&a():this._showSetModal(a)},fail:()=>{this._showSetModal(a)}})}_wxAuthorize(a,b){wx.authorize({scope:'scope.userInfo',success:()=>{Util.isFun(a)&&a()},fail:()=>{Util.isFun(b)?b():this._toSetting(a)}})}_loginLog(a=this.userSdk,b=consts.LogType.Login){this.log.postLog({gameId:this.conf.gameId,userId:a.userId,uniqueId:a.uniqueId,channel:this.log.channel,scene:this.log.scene,logType:b})}_doLogin(a){Util.showLoading('\u767B\u5F55\u4E2D...'),this.next=a;let b=this;this.checkSession((a,c)=>{b.checkSessionPass=!c,wx.getStorageSync(consts.StorageKeys.RunMode)!==this.conf.env&&(b.checkSessionPass=!1),b.checkSessionPass&&a?(Util.hideLoading(),b._loginLog(a.userSdk),b.next(a.encryptUserInfo,null,b.checkSessionPass)):b.wxLogin((a,c)=>c?(Util.hideLoading(),b.next(null,c,b.checkSessionPass),!1):void b.entry(a,(a,c)=>{if(Util.hideLoading(),c)return void b.next(null,c,b.checkSessionPass);let d=a.userSdk,e=a.encryptUserInfo;b._loginLog(d),d.isAuth?b.next(e,null,b.checkSessionPass):b.useBtnGetUserInfo&&Util.isFun(b.showGetUserInfoBtn)?b.fetchUserInfoBtn(d):b._wxAuthorize(b.fetchUserInfo.bind(b,d))}))})}setLoginBtn(a){if(!this.useBtnGetUserInfo)return!1;let b=a||this.conf.getUserInfoBtn||{};this.authInfoBtn&&(this.authInfoBtn.hide(),this.authInfoBtn.destroy());let c=wx.createUserInfoButton(b);return this.authInfoBtn=c,this.authInfoBtn}getLoginBtn(){return this.authInfoBtn}onLoginBtn(a){let b=this.authInfoBtn;return!!b&&void(b.offTap(),b.onTap((c)=>{console.log('[SDK] getGetUserInfoBtn onTap'),c&&c.encryptedData?(this.userSdk&&this.postUserInfo(c,this.userSdk),Util.isFun(a)&&a(c,null,b)):(Util.isFun(a)&&a(null,c,b),this._loginLog(this.userSdk,consts.LogType.AuthFailed))}))}showLoginBtn(){this.authInfoBtn.show()}hideLoginBtn(){this.authInfoBtn.hide()}loginFun(a,b,c,d){b&&'function'==typeof b&&(this.showGetUserInfoBtn=b.bind(this)),this._isAuthorizeLogin=!!c,this._useEncode=d&&!EncodeEmpty.isEmpty,d&&EncodeEmpty.isEmpty&&console.warn('\u6B64SDK\u4E0D\u652F\u6301\u52A0\u5BC6\u767B\u5F55'),this._doLogin(a)}login(a,b){this.loginFun(a,b,!0)}weakLogin(a,b){this.loginFun(a,b,!1)}decodeLoginFun(a,...b){this.loginFun((b,c,d)=>{b&&'string'==typeof b.userInfo?this.decodeUserInfo(b,a):a(b,c,d)},...b)}decodeLogin(a,b){this.decodeLoginFun(a,b,!0)}decodeWeakLogin(a,b){this.decodeLoginFun(a,b,!1)}encodeLogin(a,b){this.loginFun(a,b,!0,!0)}encodeWeakLogin(a,b){this.loginFun(a,b,!1,!0)}}class ShareManagerGame{constructor(){}_getUserSDKStorage(){let a=wx.getStorageSync(consts.StorageKeys.UserInfo);return a.userSdk}_getUserSDKChannel(){let a=this._getUserSDKStorage(),b='hortor_';return a&&a.channel&&(a.channel.indexOf('_')+1==a.channel.length?b=a.channel:b=a.channel+'_'),b}_getUserSDKShareCode(){let a=this._getUserSDKStorage();return a&&a.h_shareCode?a.h_shareCode:''}_getSDKAppendStr(a){let b=[],c='channel='+this._getUserSDKChannel();b.push(c),c='h_shareCode='+this._getUserSDKShareCode(),b.push(c);let d=a;return a?d+='&'+b.join('&'):d=''+b.join('&'),console.log('[SDK] share query: ',d),d}_getShareConfigId(a){let b=Util.queryToJson(a);return b.shareConfigId?b.shareConfigId:''}postLog(a,b=consts.LogType.Share){console.log('[SDK] share log',b);let c=wx.getStorageSync(consts.StorageKeys.UserInfo),d='',e='';c&&(d=c.userSdk.userId,e=c.userSdk.uniqueId);let f=this._getShareConfigId(a.query);this.log.postLog({userId:d,uniqueId:e,shareConfigId:f,gameId:this.conf.gameId,logType:b,content:a})}init(a){this.conf=this.conf||a,this.network=new NetWork,this.network.init(a),this.log=LogManager.getInstance(a),wx.onShareAppMessage(()=>{let a=this.conf.shareData;return this.onShareCb&&(a=this.onShareCb()),a.query=this._getSDKAppendStr(a.query),this.postLog(a),a})}getShareInfo(a,b){wx.getShareInfo({shareTicket:a.shareTicket,success:(c)=>{if('getShareInfo:ok'==c.errMsg){let e=Object.assign(c,a);this._getShareInfo(e,b)}else b(null,consts.WXGetShareInfoFail)},fail:()=>{b(null,consts.WXGetShareInfoFail)}})}_getShareInfo(a,b){a.openId&&(a.userId=a.openId,delete a.openId),this.network.post(consts.MessageHead.ShareInfo,{params:a,success:(a)=>{a.openGId?b(a,null):b(null,consts.WXGetShareInfoFail)},fail:()=>{b(null,consts.WXGetShareInfoFail)}})}_shareCallBack(){let a=this;return{success:(b)=>{console.log('[SDK] share success',b),a.postLog(a.originShareData,consts.LogType.ShareSuccessCount),a.postLog(a.originShareData);let c=a.originShareCbs.success;c&&c(b)},fail:()=>{console.log('[SDK] share cannel');let a=this.originShareCbs.fail;a&&a()}}}shareAppMessage(a){a.query=this._getSDKAppendStr(a.query),this.originShareCbs={},a.success&&(this.originShareCbs.success=a.success),a.fail&&(this.originShareCbs.fail=a.fail),this.originShareData=a,this.postLog(this.originShareData,consts.LogType.ShareShowCount);let b=Object.assign(a,this._shareCallBack());wx.shareAppMessage(b)}onShareAppMessage(a){a&&(this.onShareCb=a)}}class CheckRest{constructor(a){this.conf=a,this.core=SDKCore.getInstance()}startCheck(a,b){return!!wx.checkIsUserAdvisedToRest&&!this.startedCheck&&void(this.startedCheck=!0,this.heartBeatSet=Util.assign({space:300,maxGameTime:10800,callback:a},b),this._heartBeatStart(),this.core.addEvent('_handleOnShow',this._heartBeatStart.bind(this)),this.core.addEvent('_handleOnHide',this._heartBeatStop.bind(this)))}_heartBeatStop(){this._heartBeatTimer&&clearTimeout(this._heartBeatTimer)}_getTodayBeatTimes(a){let b=wx.getStorageSync(consts.StorageKeys.HeartBeatTime)||'',c=b.split('_');return a==c[0]?c[1]-0:0}_getNowDate(){let a=new Date;return`${a.getMonth()+1}/${a.getDate()}`}_heartBeatStart(a){let b=this._getNowDate(),c=this.heartBeatSet.space,d=this.heartBeatSet.maxGameTime,e=this._getTodayBeatTimes(b),f=c*e;f>=d&&this._checkNeedRest(f),'isBeat'===a&&wx.setStorageSync(consts.StorageKeys.HeartBeatTime,`${b}_${++e}`),this._heartBeatStop('clear'),this._heartBeatTimer=setTimeout(this._heartBeatStart.bind(this,'isBeat'),1e3*c)}_checkNeedRest(a){let b=this.heartBeatSet.callback;wx.checkIsUserAdvisedToRest({todayPlayedTime:a,success:(a)=>{a&&a.result&&Util.isFun(b)&&b(a)}})}static getInstance(a){return this.instance=this.instance||new CheckRest(a),this.instance}}class AdManager{constructor(a){this.conf=a,this.log=LogManager.getInstance(a),this.canUseAd=Util.geVersion('2.0.6')&&wx.createBannerAd&&wx.createRewardedVideoAd}_postLog(a,b=consts.LogType.ADClick){this.log.postLog({adUnitId:a,gameId:this.conf.gameId,channel:this.log.channel,scene:this.log.scene,logType:b})}getVideoAd(a){return!!(this.canUseAd&&a)&&wx.createRewardedVideoAd({adUnitId:a})}checkVideoAd({adUnitId:a,success:b,error:c}){console.log('[SDK] checkVideoAd');let d=this.getVideoAd(a),e=(a)=>{Util.isFun(c)&&c(a),d&&d.offError()};return d?void(d.onLoad(()=>{Util.isFun(b)&&b(res)}),d.onError(e)):e(null)}showVideoAd({adUnitId:a,onShow:b,onClose:c,onError:d}){console.log('[SDK] showVideoAd');let e=this.getVideoAd(a),f=(a)=>{Util.isFun(d)&&d(a),e&&e.offError(),console.log(`[SDK] err: ${a&&a.errMsg}`)};return e?void(this._postLog(a),e.load().then(()=>{e.show(),Util.isFun(b)&&b(),this._postLog(a,consts.LogType.ADShow)}).catch(f),e.onClose((b)=>{Util.isFun(c)&&c(b),e.offClose(),this._postLog(a,consts.LogType.ADClose)})):f({errMsg:'videoAd null'})}getBannerAd({adUnitId:a,style:b}){if(!this.canUseAd||!a||!b)return!1;let c=this.bannerAd||wx.createBannerAd({adUnitId:a,style:b});return this.bannerAd=c,c}createBannerAd(a){return this.bannerAd&&(this.bannerAd.destroy(),this.bannerAd=null),this.getBannerAd(a)}checkBannerAd({adUnitId:a,style:b,success:c,error:d}){let e=this.createBannerAd({adUnitId:a,style:b}),f=(a)=>{Util.isFun(d)&&d(a),e&&e.offError()};return e?void(e.onLoad(()=>{Util.isFun(c)&&c(res),e.offLoad()}),e.onError(f)):f(null)}showBannerAd({adUnitId:a,style:b,onShow:c,onError:d,onResize:e}){let f=this.getBannerAd({adUnitId:a,style:b}),g=(a)=>{Util.isFun(d)&&d(a),console.log(`[SDK] err: ${a&&a.errMsg}`)},h=(a)=>{Util.isFun(e)&&e(a),f.offResize()};return f?void(h&&f.onResize(h),this._postLog(a),f.show().then(()=>{Util.isFun(c)&&c(),this._postLog(a,consts.LogType.ADShow)}).catch(g)):g({errMsg:'bannerAd null'})}hideBannerAd(a,b){this.bannerAd&&(this.bannerAd.hide(),this._postLog(this.bannerAd.adUnitId||b,consts.LogType.ADClose)),Util.isFun(a)&&a()}static getInstance(a){return this.instance=this.instance||new AdManager(a),this.instance}}class GameClub{constructor(a){this.conf=a,this.log=LogManager.getInstance(a),this.btn={},this.canUseAd=Util.geVersion('2.0.3')}_postLog(){this.log.postLog({gameId:this.conf.gameId,channel:this.log.channel,scene:this.log.scene,logType:consts.LogType.GameZone})}show(a){if(!this.canUseAd||!wx.createGameClubButton)return console.warn(`[SDK] 暂不支持游戏圈`),!1;let b=wx.createGameClubButton(a||this.conf.gameClubBtn);return b.onTap(this._postLog.bind(this)),b.show(),b.close=this.close.bind(this,b),b.clear=this.clear.bind(this,b),this.btn=b,b}close(a=this.btn){Util.isFun(a.hide)&&a.hide()}clear(a=this.btn){Util.isFun(a.destroy)&&a.destroy()}static getInstance(a){return this.instance=this.instance||new GameClub(a),this.instance}}class SDKService{constructor(a){this.conf=a,this.network=new NetWork,this.network.init(a)}customerService(a){wx.openCustomerServiceConversation(a)}getDefaultSet(a,b){b(null)}checkIP(a,b){'function'==typeof a&&(b=a,a='');let{gameId:c='',gameVersion:d=''}=this.conf;this.network.post(`${this.network.Serve_HOST}${consts.MessageHead.IpCheck}`,{params:{gameId:c,gameVersion:d,interfaceId:a},success:(a)=>{Util.isFun(b)&&b(a)},fail:()=>{Util.isFun(b)&&b(!1)}})}setUserCloudStorage(a){wx.setUserCloudStorage(a)}getUserInfo(){let a=wx.getStorageSync(consts.StorageKeys.UserInfo)||{},b=a.userSdk||{};return{userId:b.userId||'',uniqueId:b.uniqueId||''}}errorLog(a){let b=this.getUserInfo(),c=Util.assign({gameId:this.conf.gameId,gameVersion:this.conf.gameVersion||'',logTp:a.logTp},b);c=Util.assign(c,a),this.network.postJSON(`${this.network.Serve_HOST}${consts.MessageHead.ErrorLog}`,{params:c})}static getInstance(a){return this.instance=this.instance||new SDKService(a),this.instance}}let SDK={login(a,b){this.loginManager.login(a,b)},weakLogin(a,b){this.loginManager.weakLogin(a,b)},decodeLogin(...a){this.loginManager.decodeLogin(...a)},decodeWeakLogin(...a){this.loginManager.decodeWeakLogin(...a)},encodeLogin(...a){this.loginManager.encodeLogin(...a)},encodeWeakLogin(...a){this.loginManager.encodeWeakLogin(...a)},getGetUserInfoBtn(...a){return this.loginManager.getGetUserInfoBtn(...a)},pay(a,b){this.payManager.pay(a,b)},getShareInfo(a,b){this.shareManagerGame.getShareInfo(a,b)},shareAppMessage(a){this.shareManagerGame.shareAppMessage(a)},onShareAppMessage(a){this.shareManagerGame.onShareAppMessage(a)},checkRest(...a){CheckRest.getInstance().startCheck(...a)},checkIP(...a){this.service.checkIP(...a)},setUserCloudStorage(...a){this.service.setUserCloudStorage(...a)},getDefaultSet(...a){this.service.getDefaultSet(...a)},customerService(...a){this.service.customerService(...a)},errorLog(...a){this.service.errorLog(...a)},checkVideoAd(...a){this.adManager.checkVideoAd(...a)},showVideoAd(...a){this.adManager.showVideoAd(...a)},checkBannerAd(...a){this.adManager.checkBannerAd(...a)},showBannerAd(...a){this.adManager.showBannerAd(...a)},hideBannerAd(...a){this.adManager.hideBannerAd(...a)},init(a){a.sdkType='minigame',a.sdkSet={openBtnGetUserInfo:!0},a.getSdkSetting&&'function'==typeof a.getSdkSetting&&a.getSdkSetting(a.sdkSet),this.core=SDKCore.getInstance(a);let b=new LoginManager,c=new PayManagerGame,d=new ShareManagerGame;b.init(a),c.init(a),d.init(a),this.loginManager=b,this.payManager=c,this.shareManagerGame=d,this.util=Util,this.gameClub=GameClub.getInstance(a),this.adManager=AdManager.getInstance(a),this.service=SDKService.getInstance(a)},getMiniCode(a){this.core.addEvent('getMiniCode',a)},getMiniCodeSync(){return this.core.getMiniCodeSync()}};module.exports=SDK;
{"version":3,"sources":["game-manager.js"],"names":["GameManager","cc","Class","properties","rowCount","columnCount","space","cubes","columnPositions","rowPositions","cubeTemplate","Node","cubePrefab","Prefab","gameNode_","halfWidth","halfHeight","maxLevel","maxHistory","leftTime","newLineTime","mainNode","cubePool","NodePool","state","default","Idle","type","idGenerator","setState","AddNewLine","Running","init","auSource","instance","getStorage","getChildByName","i","cube","instantiate","put","width","height","au_","reset","parseInt","showStarDes","onHide","Over","Pause","log","bind","restart","getComponent","Animation","play","clear","initCubes","foreachCubes","item","cell","cb","length","row","j","column","tmp","push","createCube","randLevel","Math","random","posToPoint","pos","y","x","isSameCube","cube1","cube2","com1","com2","id","removeCube","size","emit","EventType","TOUCH_END","cubeCom","cubeMoved","position","oldCell","JSON","stringify","setCellPos","getCube","setCube","warn","levelChange","level","dataManager","userInfo","submitScore","userId3","setStorage","toString","game","savePlayerData","sys","platform","WECHAT_GAME","wx","key","data","success","console","update","dt","addNewLine","isDead","topLine","topline2","gameOver","Bombing","setTimeout","get","error","parent","playBombSound","index","hideStarDes","createAd","createdAd","adsId","ad","fail","err","window","gameManager"],"mappings":"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","file":"game-manager.js","sourceRoot":"../../../../assets/Script","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\nimport {CubeState, CubeColors, GameState} from \"consts\";\nimport Platform from \"./platform/platform\";\nvar GameManager = cc.Class({\n\n  properties: {\n    rowCount: 6,\n    columnCount: 6,\n    space: 4,\n\n    cubes: [],\n    columnPositions: [],\n    rowPositions: [],\n    cubeTemplate: cc.Node,\n    cubePrefab: cc.Prefab,\n    gameNode_: null,\n\n    halfWidth: 0,\n    halfHeight: 0,\n\n    maxLevel: 0,\n    maxHistory: 0,\n    leftTime: 8,\n    newLineTime: 8,\n\n    mainNode: cc.Node,\n    cubePool: cc.NodePool,\n\n    state: {\n      default: GameState.Idle,\n      type: GameState,\n    },\n    idGenerator: 1\n  },\n\n  setState(state){\n    if (this.state === state) {\n      return;\n    }\n    switch (state) {\n      case GameState.AddNewLine: {\n        // cc.director.getPhysicsManager().enabled=false;\n        break;\n      }\n      case GameState.Running: {\n        // cc.director.getPhysicsManager().enabled=true;\n      }\n    }\n    this.state = state;\n  },\n\n  init(cubePrefab, mainNode, auSource) {\n    Platform.instance.getStorage(\"maxLevel\", function(maxLevel) {\n      this.mainNode = mainNode;\n      this.gameNode_ = mainNode.getChildByName(\"game-node\");\n      this.cubePrefab = cubePrefab;\n      this.cubePool = new cc.NodePool;\n\n      for (let i = 0; i < (this.rowCount + 1) * this.columnCount; i++) {\n        let cube = cc.instantiate(cubePrefab);\n        this.cubePool.put(cube);\n      }\n\n      this.halfWidth = this.gameNode_.width / 2;\n      this.halfHeight = this.gameNode_.height / 2;\n\n      this.cubeTemplate = cc.instantiate(this.cubePrefab);\n\n      this.au_ = auSource;\n\n      this.reset();\n      this.maxLevel = 0;\n      if (maxLevel) {\n        this.maxHistory = parseInt(maxLevel);\n      }\n\n      if (this.maxLevel <= 0) {\n        this.showStarDes(this.maxLevel);\n      }\n\n      Platform.instance.onHide(()=> {\n        if (this.state !== GameState.Over && this.state !== GameState.Pause) {\n          this.setState(GameState.Pause);\n        }\n      });\n\n      cc.log(\"game manager init\");\n    }.bind(this));\n\n  },\n\n  restart(){\n    this.reset();\n    this.mainNode.getComponent(cc.Animation).play(\"game-restart\");\n  },\n\n  reset(){\n    this.clear();\n\n    this.setState(GameState.Running);\n    this.leftTime = this.newLineTime;\n    this.maxLevel = 0;\n    this.initCubes();\n  },\n\n  clear(){\n    this.foreachCubes((item, cell)=> {\n      if (item) {\n        this.cubePool.put(item);\n      }\n    });\n    // this.gameNode_.removeAllChildren(true);\n  },\n\n  foreachCubes(cb){\n    for (let i = 0; i < this.cubes.length; i++) {\n      let row = this.cubes[i];\n      for (let j = 0; j < row.length; j++) {\n        cb(row[j], {row: i, column: j});\n      }\n    }\n  },\n\n  initCubes() {\n    this.cubes = [];\n    //初始化数组\n    for (let i = 0; i < this.rowCount; i++) {\n      let tmp = [];\n      for (let j = 0; j < this.columnCount; j++) {\n        tmp.push(null);\n        //cube的x坐标\n        if (this.columnPositions.length < this.columnCount) {\n          this.columnPositions.push(this.space + this.cubeTemplate.width / 2 + (this.cubeTemplate.width + this.space) * j);\n        }\n      }\n      //cube的y坐标\n      if (this.rowPositions.length < this.rowCount) {\n        this.rowPositions.push(this.space + this.cubeTemplate.height / 2 + (this.cubeTemplate.height + this.space) * i);\n      }\n      this.cubes.push(tmp);\n    }\n\n    //初始化cube\n    for (let i = 0; i < 2; i++) {\n      for (let j = 0; j < this.columnCount; j++) {\n        this.cubes[i][j] = this.createCube({row: i, column: j});\n      }\n    }\n  },\n\n  randLevel(){\n    // if (this.maxLevel<3){\n    //   return  parseInt(Math.random()*10)%2;\n    // }\n    // if (this.maxLevel<6){\n    //   return parseInt(Math.random()*10)%(this.maxLevel);\n    // }\n    // if (this.maxLevel<11){\n    //   return parseInt(Math.random()*10)%(this.maxLevel-1);\n    // }\n    // return Math.min(5+parseInt(Math.random()*10)%(this.maxLevel-5),14);\n    if (this.maxLevel <= 0) {\n      return this.maxLevel;\n    }\n    return parseInt(Math.random() * 10) % this.maxLevel;\n  },\n\n  posToPoint(pos){\n    let cell = {row: -1, column: -1};\n    for (let i = 0; i < this.rowCount; i++) {\n      if (pos.y < (i + 1) * (this.cubeTemplate.height + this.space)) {\n        cell.row = i;\n        break;\n      }\n    }\n    for (let j = 0; j < this.columnCount; j++) {\n      if (pos.x < (j + 1) * (this.cubeTemplate.width + this.space)) {\n        cell.column = j;\n        break;\n      }\n    }\n\n\n    if (pos.y > (this.rowCount) * (this.cubeTemplate.height + this.space)){\n      cell.row=this.rowCount-1;\n    }\n    if (pos.y<=0){\n      cell.row=0;\n    }\n\n    return cell;\n  },\n\n  isSameCube(cube1, cube2){\n    let com1 = cube1.getComponent(\"cube\");\n    let com2 = cube2.getComponent(\"cube\");\n    return com1.id === com2.id;\n  },\n\n  removeCube(cube){\n    cc.log(\"put cube back ,length:\", this.cubePool.size());\n    this.gameNode_.emit(cc.Node.EventType.TOUCH_END);\n    let cubeCom = cube.getComponent(\"cube\");\n\n    if (this.isSameCube(this.cubes[cubeCom.cell.row][cubeCom.cell.column], cube)) {\n      this.cubes[cubeCom.cell.row][cubeCom.cell.column] = null;\n    }\n    this.cubePool.put(cube);\n  },\n\n  //移动数组位置到显示位置\n  cubeMoved(cube){\n    cc.log(\"cube moved\");\n    let cell = this.posToPoint(cube.position);\n\n    let cubeCom = cube.getComponent(\"cube\");\n    let oldCell = cubeCom.cell;\n    if (cell.row === oldCell.row && cell.column === oldCell.column || !this.cubes[oldCell.row][oldCell.column]) {\n      return;\n    }\n    if (this.isSameCube(this.cubes[oldCell.row][oldCell.column], cube)) {  //删除旧位置信息\n      cc.log(\"remove old cube,cell:\", JSON.stringify(oldCell));\n      this.cubes[oldCell.row][oldCell.column] = null;\n    }\n\n    this.cubes[cell.row][cell.column] = cube;\n    cubeCom.setCellPos(cell);\n  },\n\n  getCube(row, column){\n    return this.cubes[row][column];\n  },\n\n  setCube(row, column, cube){\n    if (this.cubes[row][column]) {\n      cc.warn(\"can not set,cell is not nil\");\n      return;\n    }\n    this.cubes[row][column] = cube;\n  },\n\n  levelChange(level){\n    if (level > this.maxLevel) {\n      this.maxLevel = level;\n      if (dataManager.userInfo) {\n        Platform.instance.submitScore(dataManager.userInfo.userId3, this.maxLevel);\n      }\n      this.showStarDes(this.maxLevel);\n      if (this.maxLevel > this.maxHistory) {\n        this.maxHistory = this.maxLevel;\n        Platform.instance.setStorage(\"maxLevel\", this.maxLevel.toString());\n      }\n      cc.game.emit(\"max-level-changed\");\n    }\n  },\n\n  savePlayerData(){\n    if (cc.sys.platform === cc.sys.WECHAT_GAME) {\n      wx.setStorage({\n        key: \"maxLevel\",\n        data: this.maxLevel.toString(),\n        success: ()=> {\n          console.log(\"save level success\");\n        }\n      })\n    }\n  },\n\n  update (dt) {\n    // this.checkFallingDownPosition();\n    if (this.state !== GameState.Running) {\n      return;\n    }\n    this.leftTime -= dt;\n    if (this.leftTime <= 0) {\n      this.addNewLine();\n      this.leftTime = this.newLineTime;\n    }\n  },\n\n  isDead(){\n    let topLine = this.cubes[this.cubes.length - 1];\n    let topline2=this.cubes[this.cubes.length-2];\n    for (let i = 0; i < topLine.length; i++) {\n      if (topLine[i]&&topline2[i]) {\n        return true;\n      }\n    }\n    return false;\n  },\n\n  addNewLine(){\n    if (this.isDead()) {\n      this.gameOver();\n      return;\n    }\n    this.setState(GameState.AddNewLine);\n    for (let i = 0; i < this.cubes.length; i++) {\n      let row = this.cubes[i];\n      for (let j = 0; j < row.length; j++) {\n        let cube = row[j];\n        if (!cube) {\n          continue;\n        }\n        if (cube.getComponent(\"cube\").state === CubeState.Bombing) {\n          continue;\n        }\n        cube.emit(\"move-up\");\n      }\n    }\n\n    //避免新旧碰撞，延迟加载新0星球\n    setTimeout(()=> {\n      if (this.state != GameState.AddNewLine) {\n        return;\n      }\n      this.setState(GameState.Running);\n      for (let i = 0; i < this.columnCount; i++) {\n        let cube = this.createCube({row: 0, column: i});\n        // cube.y=-cube.height/2;\n        this.cubes[0][i] = cube;\n        // cube.emit(\"move-up\");\n      }\n    }, 200);\n  },\n  gameOver(){\n    this.setState(GameState.Over);\n    cc.game.emit(\"game-over\");\n    this.mainNode.getComponent(cc.Animation).play(\"game-over\");\n  },\n  createCube(cell){\n    let cube = this.cubePool.get();\n    cc.log(\"get cube  from pool,length:\", this.cubePool.size());\n    if (!cube) {\n      cc.error(\"over max cube pool\");\n      return;\n    }\n    let id = this.idGenerator;\n    this.idGenerator++;\n    cube.x = this.space + cube.width / 2 + (cube.width + this.space) * cell.column;\n    cube.y = this.space + cube.height / 2 + (cube.height + this.space) * cell.row;\n    cube.parent = this.gameNode_;\n    cube.getComponent(\"cube\").init(cell, this.randLevel(), id);\n    return cube;\n  },\n  playBombSound(){\n    this.au_.play();\n  },\n\n  showStarDes(index){\n    // let node=cc.find(\"star-description\");\n    // if (!node){\n    //   cc.warn(\"star-description is not find\");\n    //   return;\n    // }\n    //\n    // node.getComponent(node.name).init(index);\n    // node.active=true;\n  },\n\n  hideStarDes(index){\n    // let node=cc.find(\"star-description\");\n    // if (!node){\n    //   cc.warn(\"star-description is not find\");\n    //   return;\n    // }\n    // // node.getComponent(node.name).init(index);\n    // node.active=false;\n  },\n  createAd(){\n    Platform.instance.createdAd(\n      {\n        adsId: \"xxfc\",\n        success: (ad)=> {\n          cc.log(\"create ad success,ad:\", JSON.stringify(ad));\n        },\n        fail:(err)=>{\n          cc.log(\"create ad fail,err:\",JSON.stringify(err));\n        },\n      },\n    )\n  }\n});\n\nwindow.gameManager = new GameManager();\n"]}
{"version":3,"sources":["game-manager.js"],"names":["GameManager","cc","Class","properties","rowCount","columnCount","space","cubes","columnPositions","rowPositions","cubeTemplate","Node","cubePrefab","Prefab","gameNode_","halfWidth","halfHeight","maxLevel","maxHistory","leftTime","newLineTime","mainNode","cubePool","NodePool","state","default","Idle","type","idGenerator","setState","AddNewLine","Running","init","auSource","instance","getStorage","getChildByName","i","cube","instantiate","put","width","height","au_","reset","parseInt","showStarDes","onHide","Over","Pause","log","bind","restart","getComponent","Animation","play","clear","initCubes","foreachCubes","item","cell","cb","length","row","j","column","tmp","push","createCube","randLevel","Math","random","posToPoint","pos","y","x","warn","isSameCube","cube1","cube2","com1","com2","id","removeCube","size","emit","EventType","TOUCH_END","cubeCom","cubeMoved","position","oldCell","JSON","stringify","setCellPos","getCube","setCube","levelChange","level","dataManager","userInfo","submitScore","userId3","setStorage","toString","game","savePlayerData","sys","platform","WECHAT_GAME","wx","key","data","success","console","update","dt","addNewLine","isDead","topLine","gameOver","Bombing","setTimeout","get","error","parent","playBombSound","index","hideStarDes","window","gameManager"],"mappings":"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","file":"game-manager.js","sourceRoot":"../../../../assets/Script","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\nimport {CubeState,CubeColors,GameState} from \"consts\";\nimport Platform from \"./platform/platform\";\nvar GameManager=cc.Class({\n\n  properties: {\n    rowCount: 6,\n    columnCount: 6,\n    space: 4,\n\n    cubes: [],\n    columnPositions:[],\n    rowPositions:[],\n    cubeTemplate:cc.Node,\n    cubePrefab:cc.Prefab,\n    gameNode_: null,\n\n    halfWidth:0,\n    halfHeight:0,\n\n    maxLevel:0,\n    maxHistory:0,\n    leftTime:5,\n    newLineTime:5,\n\n    mainNode:cc.Node,\n    cubePool:cc.NodePool,\n\n    state:{\n      default:GameState.Idle,\n      type:GameState,\n    },\n    idGenerator:1\n  },\n\n  setState(state){\n    if(this.state===state){\n      return;\n    }\n    switch (state){\n      case GameState.AddNewLine:{\n        // cc.director.getPhysicsManager().enabled=false;\n        break;\n      }\n      case GameState.Running:{\n        // cc.director.getPhysicsManager().enabled=true;\n      }\n    }\n    this.state=state;\n  },\n\n  init(cubePrefab,mainNode,auSource) {\n    Platform.instance.getStorage(\"maxLevel\",function(maxLevel){\n      this.mainNode=mainNode;\n      this.gameNode_ = mainNode.getChildByName(\"game-node\");\n      this.cubePrefab=cubePrefab;\n      this.cubePool=new cc.NodePool;\n\n      for(let i=0;i<(this.rowCount+1)*this.columnCount;i++){\n        let cube=cc.instantiate(cubePrefab);\n        this.cubePool.put(cube);\n      }\n\n      this.halfWidth=this.gameNode_.width/2;\n      this.halfHeight=this.gameNode_.height/2;\n\n      this.cubeTemplate=cc.instantiate(this.cubePrefab);\n\n      this.au_=auSource;\n\n      this.reset();\n      this.maxLevel=0;\n      if (maxLevel){\n        this.maxHistory=parseInt(maxLevel);\n      }\n\n      if (this.maxLevel<=0){\n        this.showStarDes(this.maxLevel);\n      }\n\n      Platform.instance.onHide(()=>{\n        if(this.state!==GameState.Over||this.state!==GameState.Pause){\n          this.setState(GameState.Pause);\n        }\n      });\n\n      cc.log(\"game manager init\");\n    }.bind(this));\n\n  },\n\n  restart(){\n    this.reset();\n    this.mainNode.getComponent(cc.Animation).play(\"game-restart\");\n  },\n\n  reset(){\n    this.clear();\n\n    this.setState(GameState.Running);\n    this.leftTime=this.newLineTime;\n    this.maxLevel=0;\n    this.initCubes();\n  },\n\n  clear(){\n    this.foreachCubes((item,cell)=>{\n      if (item){\n        this.cubePool.put(item);\n      }\n    });\n    // this.gameNode_.removeAllChildren(true);\n  },\n\n  foreachCubes(cb){\n    for (let i=0;i<this.cubes.length;i++){\n      let row=this.cubes[i];\n      for (let j=0;j<row.length;j++){\n        cb(row[j],{row:i,column:j});\n      }\n    }\n  },\n\n  initCubes() {\n    this.cubes=[];\n    //初始化数组\n    for (let i=0;i<this.rowCount;i++){\n      let tmp=[];\n      for (let j=0;j<this.columnCount;j++){\n        tmp.push(null);\n        //cube的x坐标\n        if (this.columnPositions.length<this.columnCount){\n          this.columnPositions.push(this.space+this.cubeTemplate.width/2+(this.cubeTemplate.width+this.space)*j);\n        }\n      }\n      //cube的y坐标\n      if (this.rowPositions.length<this.rowCount){\n        this.rowPositions.push(this.space+this.cubeTemplate.height/2+(this.cubeTemplate.height+this.space)*i);\n      }\n      this.cubes.push(tmp);\n    }\n\n    //初始化cube\n    for (let i = 0; i < 2; i++) {\n      for (let j = 0; j < this.columnCount; j ++) {\n        this.cubes[i][j]=this.createCube({row:i,column:j});\n      }\n    }\n  },\n\n  randLevel(){\n    // if (this.maxLevel<3){\n    //   return  parseInt(Math.random()*10)%2;\n    // }\n    // if (this.maxLevel<6){\n    //   return parseInt(Math.random()*10)%(this.maxLevel);\n    // }\n    // if (this.maxLevel<11){\n    //   return parseInt(Math.random()*10)%(this.maxLevel-1);\n    // }\n    // return Math.min(5+parseInt(Math.random()*10)%(this.maxLevel-5),14);\n    if (this.maxLevel<=0){\n      return this.maxLevel;\n    }\n    return parseInt(Math.random()*10)%this.maxLevel;\n  },\n\n  posToPoint(pos){\n    let cell={row:0,column:0};\n    for (let i=0;i<this.rowCount;i++){\n      if (pos.y > (i+1) * (this.cubeTemplate.height+this.space)){\n        continue;\n      }\n      cell.row=i;\n      for (let j=0;j<this.columnCount;j++){\n        if (pos.x<(j+1) * (this.cubeTemplate.width+this.space)){\n          cell.column=j;\n          return cell;\n        }\n      }\n    }\n\n    cc.warn(\"invalid touch position\");\n    return cell;\n  },\n\n  isSameCube(cube1,cube2){\n    let com1=cube1.getComponent(\"cube\");\n    let com2=cube2.getComponent(\"cube\");\n    return com1.id===com2.id;\n  },\n\n  removeCube(cube){\n    cc.log(\"put cube back ,length:\",this.cubePool.size());\n    this.gameNode_.emit(cc.Node.EventType.TOUCH_END);\n    let cubeCom=cube.getComponent(\"cube\");\n\n    if(this.isSameCube(this.cubes[cubeCom.cell.row][cubeCom.cell.column],cube)){\n      this.cubes[cubeCom.cell.row][cubeCom.cell.column]=null;\n    }\n    this.cubePool.put(cube);\n  },\n\n  //移动数组位置到显示位置\n  cubeMoved(cube){\n    cc.log(\"cube moved\");\n    let cell=this.posToPoint(cube.position);\n    // if (this.cubes[cell.row][cell.column]){\n    //   cc.error(\"can not move cube\");\n    //   return;\n    // }\n\n    let cubeCom=cube.getComponent(\"cube\");\n    let oldCell=cubeCom.cell;\n    if (cell.row===oldCell.row&&cell.column===oldCell.column||!this.cubes[oldCell.row][oldCell.column]){\n      return;\n    }\n    if (this.isSameCube(this.cubes[oldCell.row][oldCell.column],cube)){  //删除旧位置信息\n      cc.log(\"remove old cube,cell:\",JSON.stringify(oldCell));\n      this.cubes[oldCell.row][oldCell.column]=null;\n    }\n    // else if(this.cubes[oldCell.row][oldCell.column]&&this.cubes[oldCell.row][oldCell.column]!==cube){//当前位置已存在\n    //   if (cell.row>=this.cubes.length-2){\n    //     cc.warn(\"move to top\");\n    //     return;\n    //   }\n    //   cell.row+=1;\n    // }\n\n    this.cubes[cell.row][cell.column]=cube;\n    cubeCom.setCellPos(cell);\n  },\n\n  getCube(row,column){\n    return this.cubes[row][column];\n  },\n\n  setCube(row,column,cube){\n    if (this.cubes[row][column]){\n      cc.warn(\"can not set,cell is not nil\");\n      return;\n    }\n    this.cubes[row][column]=cube;\n  },\n\n  levelChange(level){\n    if (level>this.maxLevel){\n      this.maxLevel=level;\n      if(dataManager.userInfo){\n        Platform.instance.submitScore(dataManager.userInfo.userId3,this.maxLevel);\n      }\n      this.showStarDes(this.maxLevel);\n      if (this.maxLevel>this.maxHistory){\n        this.maxHistory=this.maxLevel;\n        Platform.instance.setStorage(\"maxLevel\",this.maxLevel.toString());\n      }\n      cc.game.emit(\"max-level-changed\");\n    }\n  },\n\n  savePlayerData(){\n    if (cc.sys.platform === cc.sys.WECHAT_GAME){\n      wx.setStorage({\n        key:\"maxLevel\",\n        data:this.maxLevel.toString(),\n        success:()=>{\n          console.log(\"save level success\");\n        }\n      })\n    }\n  },\n\n  update (dt) {\n    // this.checkFallingDownPosition();\n    if(this.state!==GameState.Running){\n      return;\n    }\n    this.leftTime-=dt;\n    if (this.leftTime<=0){\n      this.addNewLine();\n      this.leftTime=this.newLineTime;\n    }\n  },\n\n  isDead(){\n    let topLine=this.cubes[this.cubes.length-1];\n    for (let i=0;i<topLine.length;i++){\n      if (topLine[i]){\n        return true;\n      }\n    }\n    return false;\n  },\n\n  addNewLine(){\n    if(this.isDead()){\n      this.gameOver();\n      return;\n    }\n    this.setState(GameState.AddNewLine);\n    for(let i=0;i<this.cubes.length;i++) {\n      let row=this.cubes[i];\n      for (let j=0;j<row.length;j++) {\n        let cube=row[j];\n        if (!cube){\n          continue;\n        }\n        if (cube.getComponent(\"cube\").state===CubeState.Bombing){\n          this.removeCube(cube);\n          continue;\n        }\n        cube.emit(\"move-up\");\n        // this.cubes[i][j]=null;\n      }\n    }\n\n    //避免新旧碰撞，延迟加载新0星球\n    setTimeout(()=>{\n      if (this.state!=GameState.AddNewLine){\n        return;\n      }\n      this.setState(GameState.Running);\n      for (let i=0;i<this.columnCount;i++){\n        let cube=this.createCube({row:0,column:i});\n        // cube.y=-cube.height/2;\n        this.cubes[0][i]=cube;\n        // cube.emit(\"move-up\");\n      }\n    },100);\n  },\n  gameOver(){\n    this.setState(GameState.Over);\n    cc.game.emit(\"game-over\");\n    this.mainNode.getComponent(cc.Animation).play(\"game-over\");\n  },\n  createCube(cell){\n    let cube=this.cubePool.get();\n    cc.log(\"get cube  from pool,length:\",this.cubePool.size());\n    if(!cube){\n      cc.error(\"over max cube pool\");\n      return;\n    }\n    let id=this.idGenerator;\n    this.idGenerator++;\n    cube.x=this.space+cube.width/2+(cube.width+this.space)*cell.column;\n    cube.y=this.space+cube.height/2+(cube.height+this.space)*cell.row;\n    cube.parent=this.gameNode_;\n    cube.getComponent(\"cube\").init(cell,this.randLevel(),id);\n    return cube;\n  },\n  playBombSound(){\n    this.au_.play();\n  },\n\n  showStarDes(index){\n    // let node=cc.find(\"star-description\");\n    // if (!node){\n    //   cc.warn(\"star-description is not find\");\n    //   return;\n    // }\n    //\n    // node.getComponent(node.name).init(index);\n    // node.active=true;\n  },\n\n  hideStarDes(index){\n    // let node=cc.find(\"star-description\");\n    // if (!node){\n    //   cc.warn(\"star-description is not find\");\n    //   return;\n    // }\n    // // node.getComponent(node.name).init(index);\n    // node.active=false;\n  },\n});\n\nwindow.gameManager=new GameManager();\n"]}
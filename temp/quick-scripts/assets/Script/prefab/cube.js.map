{"version":3,"sources":["cube.js"],"names":["cc","Class","extends","Component","properties","state","default","Normal","type","cell","p","star","levelUpAnimation","Prefab","id","onEnable","node","on","Node","EventType","TOUCH_START","onTouchStart","TOUCH_MOVE","onTouchMove","TOUCH_CANCEL","onTouchEnd","TOUCH_END","onLevelUp","onMoveUp","touchStartPos","onDisable","off","setState","Block","isTouched","Touched","TouchMove","levelUp","gameManager","levelChange","starType","playLevelUpAnimation","playBombSound","init","setStarType","disablePhysics","start","setCellPos","log","js","formatStr","JSON","stringify","Bombing","error","resetY","resetX","cubeMoved","FallingDown","activePhysics","FallingBottom","update","dt","removeCube","fitCell","checkFallingDown","y","height","space","touch","AddNewLine","getLocation","parent","emit","dis","pDistance","pSub","newCell","posToPoint","position","row","column","checkBombing","cube1","cube2","onBeginContact","contact","selfCollider","otherCollider","body","RigidBodyType","Static","cubeSelf","getComponent","cubeOther","rowPositions","toString","x","columnPositions","RigidBody","awake","Dynamic","Running","downCube","getCube","moveTouchedCubeUp","moveTo","pAdd","runAction","sequence","callFunc","ani","instantiate","addChild"],"mappings":"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","file":"cube.js","sourceRoot":"../../../../../assets/Script/prefab","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\n// import {CubeState} from './color-cube';\nimport {CubeState,StarTypes,GameState} from \"../consts\";\nimport Star from \"./star.js\";\n\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    state:{\n      default:CubeState.Normal,\n      type:CubeState\n    },\n    cell:cc.p(0,0),\n    star:{\n      default:null,\n      type:Star\n    },\n    levelUpAnimation:cc.Prefab,\n    id:0,\n  },\n\n  // LIFE-CYCLE CALLBACKS:\n\n  onEnable() {\n    this.node.on(cc.Node.EventType.TOUCH_START,this.onTouchStart,this);\n    this.node.on(cc.Node.EventType.TOUCH_MOVE,this.onTouchMove,this);\n    // this.gameNode = cc.find(\"/Canvas/game-node\", cc.director.getRunningScene());\n    this.node.on(cc.Node.EventType.TOUCH_CANCEL,this.onTouchEnd,this);\n    this.node.on(cc.Node.EventType.TOUCH_END,this.onTouchEnd,this);\n\n    this.node.on(\"level-up\",this.onLevelUp,this);\n\n    this.node.on(\"move-up\",this.onMoveUp,this);\n\n    this.touchStartPos=cc.p(0,0);\n  },\n\n  onDisable(){\n    this.node.off(cc.Node.EventType.TOUCH_START,this.onTouchStart,this);\n    this.node.off(cc.Node.EventType.TOUCH_MOVE,this.onTouchMove,this);\n    // this.gameNode = cc.find(\"/Canvas/game-node\", cc.director.getRunningScene());\n    this.node.off(cc.Node.EventType.TOUCH_CANCEL,this.onTouchEnd,this);\n    this.node.off(cc.Node.EventType.TOUCH_END,this.onTouchEnd,this);\n\n    this.node.off(\"level-up\",this.onLevelUp,this);\n\n    this.node.off(\"move-up\",this.onMoveUp,this);\n    this.setState(CubeState.Block);\n  },\n\n  isTouched(){\n    return this.state===CubeState.Touched||this.state===CubeState.TouchMove;\n  },\n\n  // destroy(){\n  //   this.gameNode.off(cc.Node.EventType.TOUCH_END,this.onTouchEnd,this);\n  // },\n\n  onLevelUp(){\n    this.star.levelUp();\n    gameManager.levelChange(this.star.starType);\n    // gameManager.playDeadAction(this.node.position);\n    this.playLevelUpAnimation();\n    gameManager.playBombSound();\n  },\n\n  init(cell,starType,id) {\n    this.cell=cell;\n    this.star.setStarType(starType);\n    this.disablePhysics();\n    this.id=id;\n    // this.state=CubeState.Normal;\n    this.setState(CubeState.Normal);\n  },\n\n  start() {\n\n  },\n\n  setCellPos(cell){\n    this.cell=cell;\n  },\n\n  setState(state) {\n    cc.log(cc.js.formatStr(\"set state,old:%d,new:%d,pos:%s\",this.state,state,JSON.stringify(this.cell)));\n    if (this.state===CubeState.Bombing&&state!==CubeState.Block){\n      cc.error(\"cube is marking dead\");\n      return;\n    }\n    if (this.state===state){\n      return;\n    }\n    switch (state){\n      case CubeState.Normal:{\n        this.disablePhysics();\n        this.resetY();\n        this.resetX();\n        gameManager.cubeMoved(this.node);\n        break;\n      }\n      case CubeState.TouchMove:{\n        break;\n      }\n      case CubeState.Touched:\n      case CubeState.FallingDown:{\n        this.activePhysics();\n        // this.resetX();\n      }\n      case CubeState.FallingBottom:{\n        break;\n      }\n    }\n    this.state=state;\n  },\n\n  update(dt) {\n\n    //添加新行时暂停下落\n    switch (this.state){\n      case CubeState.Bombing:{\n        gameManager.removeCube(this.node);\n        return;\n      }\n      case CubeState.TouchMove:{\n        this.fitCell();\n        break;\n      }\n      case CubeState.Normal:{\n        // this.disablePhysics();\n        this.checkFallingDown();\n        break;\n      }\n      case CubeState.FallingBottom:{\n        this.resetY();\n        this.setState(CubeState.Normal);\n        break;\n      }\n    }\n    //非touch状态时进行触底检查\n    if (this.state!==CubeState.Touched&&this.state!==CubeState.TouchMove){\n      if (this.node.y<this.node.height/2+gameManager.space){\n        this.setState(CubeState.FallingBottom);\n      }\n    }\n  },\n\n  onTouchStart(touch){\n    cc.log(\"on touch start\");\n    if(this.state===CubeState.AddNewLine){\n      return;\n    }\n    this.setState(CubeState.Touched);\n    // let body=this.node.getComponent(cc.RigidBody);\n    // body.awake=true;\n    // body.type=cc.RigidBodyType.Dynamic;\n\n    this.activePhysics();\n    this.touchStartPos=touch.getLocation();\n  },\n\n  onTouchEnd(touch){\n    cc.log(\"on touch end\");\n    this.node.parent.emit(cc.Node.EventType.TOUCH_END);   //告知touch关节触摸结束\n    if (this.state!==CubeState.Touched&&this.state!==CubeState.TouchMove){\n      return;\n    }\n    //重置mouse关节的冲量\n    this.disablePhysics();\n    this.setState(CubeState.FallingDown);\n    this.resetX();\n\n    this.touchStartPos=cc.p(0,0);\n  },\n\n  onTouchMove(touch){\n    cc.log(\"on touch moved\");\n    let dis=cc.pDistance(cc.pSub(touch.getLocation(),this.touchStartPos),cc.p(0,0));\n    if (dis>3){\n      if (this.state===CubeState.Touched){\n        this.setState(CubeState.TouchMove);\n        // gameManager.cubeMove(this.cell);\n\n      }\n    }\n  },\n\n  fitCell(){\n    let newCell=gameManager.posToPoint(this.node.position);\n    if (newCell.row!==this.cell.row||newCell.column!==this.cell.column){\n      gameManager.cubeMoved(this.node);\n\n    }\n  },\n\n  checkBombing(cube1,cube2){\n    if (cube1.star.starType!== cube2.star.starType) {\n      return false;\n    }\n\n    if (cube1.state === CubeState.Bombing) {\n      return false;\n    }\n\n    if (cube1.state===CubeState.TouchMove||cube1.state===CubeState.FallingDown){\n      return true;\n    }\n    return false;\n  },\n\n  //仅动态类型才处理碰撞\n  onBeginContact: function (contact, selfCollider, otherCollider) {\n    if (selfCollider.body.type===cc.RigidBodyType.Static||gameManager.state===GameState.AddNewLine){\n      return;\n    }\n\n    let cubeSelf=selfCollider.node.getComponent(\"cube\");\n    let cubeOther=otherCollider.getComponent(\"cube\");\n    if (!cubeSelf||!cubeOther){\n      return;\n    }\n\n    if (this.checkBombing(cubeSelf,cubeOther)){\n      cubeSelf.setState(CubeState.Bombing);\n      cubeOther.node.emit(\"level-up\");\n      return;\n    }\n\n    if (cubeSelf.state===CubeState.FallingDown){\n      cubeSelf.setState(CubeState.FallingBottom);\n    }\n  },\n\n  resetY(){\n    //更新cube的y坐标\n    cc.log(\"reset y called\");\n    let cell=gameManager.posToPoint(this.node.position);\n    this.node.y=gameManager.rowPositions[cell.row];\n    cc.log(\"reset y,new y:\"+this.node.y.toString());\n  },\n  resetX(){\n    //更新cube的x坐标\n    cc.log(\"reset x called\");\n    let cell=gameManager.posToPoint(this.node.position);\n    this.node.x=gameManager.columnPositions[cell.column];\n    cc.log(\"reset x,new x:\"+this.node.x.toString());\n  },\n\n  activePhysics(){\n    let body=this.node.getComponent(cc.RigidBody);\n    body.awake=true;\n    body.type=cc.RigidBodyType.Dynamic;\n  },\n\n  disablePhysics(){\n    let body=this.node.getComponent(cc.RigidBody);\n    if (body.type!==cc.RigidBodyType.Static){\n      body.type=cc.RigidBodyType.Static;\n    }\n  },\n\n  checkFallingDown(){\n    if (this.cell.row<=0||gameManager.state!==GameState.Running){\n      return;\n    }\n    let downCube=gameManager.getCube(this.cell.row-1,this.cell.column);\n    if (!downCube){\n      this.setState(CubeState.FallingDown);\n    }\n  },\n\n  moveTouchedCubeUp(){\n    this.disablePhysics();\n    let moveTo=cc.moveTo(0.2,cc.pAdd(this.node.position,cc.p(0,this.node.height+gameManager.space)));\n    this.node.runAction(cc.sequence(moveTo,cc.callFunc(()=>{\n      this.activePhysics();\n      // this.setState(CubeState.Touched);\n    })));\n  },\n\n  onMoveUp(){\n    if (this.state===CubeState.Touched||this.state===CubeState.TouchMove){\n      if(this.cell.row===0){\n        this.moveTouchedCubeUp();\n        return;\n      }\n      return;\n    }\n    this.setState(CubeState.Block);\n    this.disablePhysics();\n    let moveTo=cc.moveTo(0.2,cc.pAdd(this.node.position,cc.p(0,this.node.height+gameManager.space)));\n    this.node.runAction(cc.sequence(moveTo,cc.callFunc(()=>{\n      this.setState(CubeState.Normal);\n    })));\n  },\n\n  playLevelUpAnimation(){\n    if (!this.levelUpAnimation){\n      return;\n    }\n    let ani=cc.instantiate(this.levelUpAnimation);\n    this.node.addChild(ani);\n  },\n});\n"]}